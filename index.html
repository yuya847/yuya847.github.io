<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ãƒ†ã‚­ã‚¹ãƒˆQRã‚³ãƒ¼ãƒ‰å¤‰æ›</title>

<!-- favicon / iOS -->
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="/apple-touch-icon-180.png" sizes="180x180">
<meta name="theme-color" content="#0d47a1">

<style>
:root{
  --md-primary:#0d47a1; /* æ¿ƒé’ */
  --md-accent:#039be5;  /* æ°´è‰² */
  --md-danger:#d32f2f;  /* èµ¤ */
  --md-chip:#81d4fa;    /* ã‚¿ãƒ–é¸æŠè‰² */
  --md-surface:#eceff1; /* ã‚µãƒ¼ãƒ•ã‚§ã‚¹ */
  --fg:#222; --bg:#fff; --muted:#666; --br:#d8dde3;
}
html,body{height:100%}
body{margin:0;font-family:Meiryo,"Yu Gothic",sans-serif;color:var(--fg);background:var(--bg);display:flex;flex-direction:column}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
header{background:var(--md-primary);color:#fff;padding:12px 16px}
header .top{display:flex;align-items:center;justify-content:space-between;gap:12px}
header h1{margin:0;font-size:18px}
.badge{display:inline-block;background:rgba(255,255,255,.12);color:#fff;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.25)}

/* ã‚³ãƒ³ãƒ†ãƒŠ */
.container{padding:12px;display:flex;flex-direction:column;gap:12px}

/* ãƒ¢ãƒ¼ãƒ‰ã‚¿ãƒ–ï¼ˆå¸¸ã«4Ã—2ã‚°ãƒªãƒƒãƒ‰ï¼‰ */
.mode .seg{
  display:grid; grid-template-columns:repeat(4,minmax(0,1fr));
  gap:10px; padding:10px; border:1px solid var(--br); border-radius:14px; background:#fff;
}
.mode .seg button{
  padding:10px 12px; border:1px solid var(--br); border-radius:999px; background:#fff; color:#222; cursor:pointer;
  transition:background .15s,box-shadow .15s,transform .06s;
}
.mode .seg button.sel{ background:var(--md-chip); color:#0a2b55; font-weight:700; border-color:#6abff0; }
.mode .seg button:hover{ transform:translateY(-1px); box-shadow:0 2px 8px rgba(0,0,0,.1); }

/* 2ã‚«ãƒ©ãƒ é ˜åŸŸï¼ˆ<=1024pxã¯1åˆ—ï¼‰ */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:1024px){ .grid{grid-template-columns:1fr} }

.panel{border:1px solid var(--br);border-radius:10px;padding:12px;background:#fff;display:flex;flex-direction:column;gap:10px}
.panel h2{margin:0 0 2px;font-size:16px}
.muted{color:var(--muted);font-size:13px}

textarea{width:100%;min-height:260px;resize:vertical;font-size:16px;line-height:1.5;padding:10px;border:1px solid #cfd6dd;border-radius:8px;box-sizing:border-box}

/* è¡Œ */
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.row.right{justify-content:flex-end}
.row.split{justify-content:space-between}

/* ãƒœã‚¿ãƒ³ */
button,select,input[type="text"],input[type="file"],input[type="number"]{
  font-size:15px;padding:9px 12px;border:1px solid #cfd6dd;border-radius:8px;background:#fff
}
button{cursor:pointer}
.btn{color:#fff;border:none}
.btn-primary{background:var(--md-primary)}
.btn-accent{background:var(--md-accent)}
.btn-danger{background:var(--md-danger)}
.btn-surface{background:var(--md-surface);color:#0b2239}
button:disabled{opacity:.6;cursor:default}
button:hover:not(:disabled){filter:brightness(1.03)}
button:active:not(:disabled){filter:brightness(.95)}

/* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ï¼ˆFILEâ†’B64ï¼‰ */
.drop{
  border:2px dashed #9fb2c6;border-radius:10px;background:#f8fbff; color:#3a5169;
  display:flex; align-items:center; justify-content:center; text-align:center; padding:24px; min-height:260px;
}
.drop.hover{ background:#eef6ff; }

/* QRé€å‡º */
.qr-wrap{display:flex;align-items:center;justify-content:center;height:340px;background:#fff;border:1px solid #e7ecf1;border-radius:10px}
.qr-scrub{display:flex;align-items:center;gap:8px}
.time{min-width:60px;text-align:right;font-variant-numeric:tabular-nums}

/* QRå—ä¿¡ï¼ˆã‚«ãƒ¡ãƒ©ï¼‰ */
.video-box{position:relative}
video#cam{width:100%;max-height:320px;background:#000;border-radius:8px;display:block}
canvas.overlay{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;border-radius:8px}

/* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ˜ãƒ«ãƒ—ï¼‰ */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:9999}
.modal.show{display:flex}
.modal .box{width:min(900px,92vw);max-height:86vh;overflow:auto;background:#fff;border-radius:12px;padding:14px 16px;box-shadow:0 12px 30px rgba(0,0,0,.2)}
.modal .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px;border-bottom:1px solid var(--br);padding-bottom:8px;margin-bottom:10px}
.modal .btn-close{background:#eee}
.qr-cell{width:120px;height:120px;border:1px solid #eee;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#fff}
</style>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js" defer></script>
</head>
<body>
<header>
  <div class="top">
    <h1>ãƒ†ã‚­ã‚¹ãƒˆQRã‚³ãƒ¼ãƒ‰å¤‰æ›</h1>
    <div class="row" style="gap:10px">
      <span id="ver" class="badge"></span>
      <button id="btn-help" class="btn btn-accent">ãƒ˜ãƒ«ãƒ—</button>
    </div>
  </div>
</header>

<div class="container">
  <!-- ãƒ¢ãƒ¼ãƒ‰ -->
  <div class="mode">
    <div class="seg" role="tablist" aria-label="mode">
      <button id="m-enc" class="sel" role="tab">Aaâ†’B64</button>
      <button id="m-dec" role="tab">B64â†’Aa</button>
      <button id="m-file" role="tab">ğŸ“â†’B64</button>
      <button id="m-b2f" role="tab">B64â†’ğŸ“</button>
      <button id="m-cam" role="tab">QRâ†’B64</button>
      <button id="m-camtxt" role="tab">QRâ†’Aa</button>
      <button id="m-cam-multi" role="tab">QRsâ†’B64</button>
      <button id="m-camtxt-multi" role="tab">QRsâ†’Aa</button>
    </div>
  </div>

  <!-- I/Oï¼ˆå…±é€šã‚°ãƒªãƒƒãƒ‰ã€‚ã‚¹ãƒãƒ›ã¯ä¸Šä¸‹ï¼‰ -->
  <div class="grid" id="text-io">
    <!-- å…¥åŠ› -->
    <section class="panel" id="panel-input">
      <h2 id="input-title">å…¥åŠ›</h2>

      <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ï¼ˆENC / DEC / B2F ã§ä½¿ç”¨ï¼‰ -->
      <textarea id="input" placeholder="ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯Base64ã‚’å…¥åŠ›â€¦"></textarea>

      <!-- ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ï¼ˆFILEï¼‰ -->
      <div id="drop-zone" class="drop" style="display:none;">
        ã“ã“ã¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯
        <button id="btn-file-choose" class="btn btn-surface" style="margin-left:8px">ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</button>
        <input id="file-input" type="file" style="display:none"/>
      </div>

      <!-- B2Fä¸‹éƒ¨ï¼ˆå·¦ã«ãƒšãƒ¼ã‚¹ãƒˆï¼å³ã«ä¿å­˜UIï¼‰ -->
      <div id="b2f-row" class="row split" style="display:none;">
        <div class="row">
          <button id="btn-paste" class="btn btn-accent">ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚’ãƒšãƒ¼ã‚¹ãƒˆ</button>
          <button id="btn-clear" class="btn btn-danger">ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="row">
          <label>å½¢å¼
            <select id="filetype">
              <option value="pdf">PDF</option>
              <option value="docx">Word (.docx)</option>
              <option value="xlsx">Excel (.xlsx)</option>
              <option value="pptx">PowerPoint (.pptx)</option>
              <option value="png">PNG</option>
              <option value="jpg">JPEG</option>
              <option value="mp4">MP4</option>
              <option value="exe">EXE</option>
              <option value="bin">ãƒã‚¤ãƒŠãƒª (.bin)</option>
            </select>
          </label>
          <input id="filename" type="text" placeholder="ä¿å­˜æ™‚ã®ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæ‹¡å¼µå­ãªã—ï¼‰" style="min-width:220px">
          <button id="btn-save" class="btn btn-primary">åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜</button>
        </div>
      </div>

      <!-- ãƒ†ã‚­ã‚¹ãƒˆç³»ã®ä¸‹éƒ¨ï¼ˆENC/DEC å°‚ç”¨ï¼‰ -->
      <div id="text-row" class="row" style="display:flex;">
        <button id="btn-paste-txt" class="btn btn-accent">ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚’ãƒšãƒ¼ã‚¹ãƒˆ</button>
        <div class="row right" style="flex:1">
          <button id="btn-convert-qr" class="btn btn-primary">å¤‰æ›ï¼‹QRã‚’è¡¨ç¤ºï¼ˆShift+Enterï¼‰</button>
          <button id="btn-convert" class="btn btn-accent">å¤‰æ›ï¼ˆCtrl+Enterï¼‰</button>
          <button id="btn-clear-txt" class="btn btn-danger">ã‚¯ãƒªã‚¢</button>
        </div>
      </div>
    </section>

    <!-- å‡ºåŠ› -->
    <section class="panel" id="panel-output">
      <h2 id="output-title">å‡ºåŠ›</h2>
      <textarea id="output" placeholder="ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
      <div class="row right" id="row-output-actions">
        <button id="btn-copy" class="btn btn-primary">ã‚³ãƒ”ãƒ¼</button>
        <button id="btn-qrshow" class="btn btn-accent">QRè¡¨ç¤ºï¼ˆé€£ç¶šï¼‰</button>
      </div>
    </section>
  </div>

  <!-- QRé€å‡ºï¼ˆãƒ†ã‚­ã‚¹ãƒˆç³»ã®ã¨ãã®ã¿ï¼‰ -->
  <section class="panel" id="qr-send">
    <h2>QRã‚·ãƒ¼ã‚±ãƒ³ã‚¹å‡ºåŠ›</h2>
    <div class="qr-wrap" id="qr-display"></div>
    <div class="qr-scrub">
      <span id="elapsed" class="time">00:00</span>
      <input id="scrub" type="range" min="0" max="0" step="1" value="0" style="flex:1"/>
      <span id="duration" class="time">00:00</span>
      <span id="frame-ind" class="muted">0 / 0</span>
    </div>
    <div class="row" style="justify-content:center;gap:10px">
      <button id="btn-prev" class="btn btn-surface">â®</button>
      <button id="btn-play" class="btn btn-primary">â–¶</button>
      <button id="btn-next" class="btn btn-surface">â­</button>
      <div class="row" style="align-items:center">
        <label style="margin-right:6px">é€Ÿåº¦(FPS)</label>
        <input id="fps" type="range" min="0.5" max="120" step="0.1" value="1.0" style="width:220px"/>
        <input id="fps-num" type="number" min="0.5" max="120" step="0.1" value="1.0" style="width:92px;text-align:right"/>
      </div>
      <label class="row" style="gap:6px;margin-left:8px">
        <input id="no-header" type="checkbox" checked> ãƒ˜ãƒƒãƒ€ãªã—ï¼ˆé›»å­ã‚«ãƒ«ãƒ†å‘ã‘ï¼‰
      </label>
    </div>
  </section>

  <!-- QRå…¥åŠ›ï¼ˆã‚«ãƒ¡ãƒ©ï¼‰ -->
  <div class="grid" id="cam-grid" style="display:none;">
    <section class="panel" id="qr-recv">
      <h2>QRå…¥åŠ›</h2>
      <div class="row" style="gap:10px">
        <button id="btn-scan-start" class="btn btn-accent">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
        <button id="btn-scan-stop" class="btn btn-danger">åœæ­¢</button>
      </div>

      <details id="cam-opts" style="margin-top:4px">
        <summary class="muted">ã‚ªãƒ—ã‚·ãƒ§ãƒ³</summary>
        <div class="row" style="margin-top:6px;gap:14px">
          <label class="muted" style="gap:6px;display:flex;align-items:center">
            <input id="auto-stop-hl" type="checkbox"> ãƒ˜ãƒƒãƒ€ãªã—ã¯1æšèª­ã‚“ã ã‚‰è‡ªå‹•åœæ­¢ï¼ˆQRâ†’ãƒ†ã‚­ã‚¹ãƒˆï¼‰
          </label>
          <div id="grid-opts" class="row" style="display:none">
            <label>è¡Œ: <input id="rows" type="number" min="1" max="6" value="2" style="width:64px"></label>
            <label>åˆ—: <input id="cols" type="number" min="1" max="6" value="2" style="width:64px"></label>
            <label>ROIä½™ç™½(px): <input id="roi-margin" type="number" min="0" max="80" value="16" style="width:84px"></label>
          </div>
        </div>
      </details>

      <div class="video-box" style="margin-top:8px">
        <video id="cam" playsinline muted></video>
        <canvas id="cam-overlay" class="overlay"></canvas>
      </div>
      <canvas id="cam-canvas" style="display:none"></canvas>
      <div class="muted">å—ä¿¡é€²æ—ï¼ˆãƒ˜ãƒƒãƒ€ä»˜ãæ™‚ï¼‰ï¼š<span id="rx-status">0/0</span></div>
    </section>

    <section class="panel">
      <h2>å‡ºåŠ›</h2>
      <textarea id="cam-output" placeholder="ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
      <div class="row right">
        <button id="btn-copy-cam" class="btn btn-primary">ã‚³ãƒ”ãƒ¼</button>
      </div>
    </section>
  </div>
</div>

<!-- ãƒ˜ãƒ«ãƒ— -->
<div id="help-modal" class="modal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true" aria-labelledby="help-title">
    <div class="topbar">
      <h2 id="help-title">ãƒ˜ãƒ«ãƒ—</h2>
      <div class="row">
        <button id="btn-help-print" class="btn btn-surface">å°åˆ·</button>
        <button id="btn-help-close" class="btn btn-surface btn-close">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    <div class="content">
      <h3>æ¦‚è¦</h3>
      <ul>
        <li>â‘  ãƒ†ã‚­ã‚¹ãƒˆ/ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›ã—ã¦ <b>QRã‚³ãƒ¼ãƒ‰åŒ–</b> ã§ãã¾ã™ã€‚</li>
        <li>â‘¡ ã‚«ãƒ«ãƒ†ç«¯æœ«ã®ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ï¼ˆä¾‹ï¼šDS9308ï¼‰ã§èª­ã¿å–ã‚‹æƒ³å®šã§ã™ã€‚</li>
        <li>â‘¢ é€†æ–¹å‘ï¼šQRâ†’Base64 / QRâ†’ãƒ†ã‚­ã‚¹ãƒˆ ã‚‚å¯èƒ½ã€‚ãƒ˜ãƒƒãƒ€ä»˜ãã¯é †åºå¾©å…ƒã—ã¾ã™ã€‚</li>
      </ul>

      <h3>ãƒ¢ãƒ¼ãƒ‰</h3>
      <ul>
        <li><b>Aaâ†’B64</b> / <b>B64â†’Aa</b>ï¼šãƒ†ã‚­ã‚¹ãƒˆã¨Base64ã®ç›¸äº’å¤‰æ›ã€‚<kbd>Ctrl</kbd>+<kbd>Enter</kbd> ã§å¤‰æ›ã€<kbd>Shift</kbd>+<kbd>Enter</kbd> ã§å¤‰æ›ï¼‹QRè¡¨ç¤ºã€‚</li>
        <li><b>ğŸ“â†’B64</b>ï¼šãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§Base64åŒ–â†’QRè¡¨ç¤ºå¯ã€‚</li>
        <li><b>B64â†’ğŸ“</b>ï¼šBase64ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å…ƒã—ã¦ä¿å­˜ï¼ˆmp4ç­‰ã«å¯¾å¿œï¼‰ã€‚</li>
        <li><b>QRâ†’B64 / QRâ†’Aa / QRsâ†’*</b>ï¼šã‚«ãƒ¡ãƒ©ã§å˜ä¸€ã¾ãŸã¯è¤‡æ•°QRã‚’èª­ã¿å–ã‚Šã€‚</li>
      </ul>

      <h3>ãŠå•ã„åˆã‚ã›</h3>
      <div class="row" style="align-items:center;gap:12px">
        <div id="help-qr" class="qr-cell" aria-label="é€£çµ¡å…ˆQR"></div>
        <div>
          <div><strong>ãƒ¡ãƒ¼ãƒ«:</strong> <a href="mailto:suzuki.yuya.kitasato@gmail.com">suzuki.yuya.kitasato@gmail.com</a></div>
          <div class="muted">â€» å·¦ã®QRã‹ã‚‰ã‚‚èª­ã¿å–ã‚Œã¾ã™ã€‚</div>
        </div>
      </div>

      <h3>ãƒãƒ¼ã‚¸ãƒ§ãƒ³</h3>
      <div id="about-version" class="muted"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const APP_VERSION='ver 1.5'; const APP_BUILD='2025-08-10';
  document.getElementById('ver').textContent = APP_VERSION;

  const $ = id => document.getElementById(id);
  const on = (node, ev, fn) => node && node.addEventListener(ev, fn, false);

  /* è¦ç´  */
  const el = {
    // tabs
    mEnc:$('m-enc'), mDec:$('m-dec'), mFile:$('m-file'), mB2F:$('m-b2f'),
    mCamB64:$('m-cam'), mCamTxt:$('m-camtxt'), mCamB64M:$('m-cam-multi'), mCamTxtM:$('m-camtxt-multi'),
    // panels
    textIO:$('text-io'), panelInput:$('panel-input'), panelOutput:$('panel-output'),
    input:$('input'), output:$('output'),
    drop:$('drop-zone'), fileBtn:$('btn-file-choose'), fileInput:$('file-input'),
    // text row buttons
    textRow:$('text-row'), btnPasteTxt:$('btn-paste-txt'), btnClearTxt:$('btn-clear-txt'),
    btnConvert:$('btn-convert'), btnConvertQR:$('btn-convert-qr'),
    // b2f row
    b2fRow:$('b2f-row'), btnPaste:$('btn-paste'), btnClear:$('btn-clear'),
    filetype:$('filetype'), filename:$('filename'), btnSave:$('btn-save'),
    // output actions
    btnCopy:$('btn-copy'), btnQR:$('btn-qrshow'),
    // qr send
    qrSend:$('qr-send'), qrWrap:$('qr-display'), scrub:$('scrub'),
    elapsed:$('elapsed'), duration:$('duration'), frameInd:$('frame-ind'),
    btnPrev:$('btn-prev'), btnNext:$('btn-next'), btnPlay:$('btn-play'),
    fps:$('fps'), fpsNum:$('fps-num'), noHdr:$('no-header'),
    // cam grid
    camGrid:$('cam-grid'), cam:$('cam'), camCanvas:$('cam-canvas'), camOverlay:$('cam-overlay'),
    btnScanStart:$('btn-scan-start'), btnScanStop:$('btn-scan-stop'),
    rxStatus:$('rx-status'), autoStopHL:$('auto-stop-hl'),
    // cam output
    camOutput:$('cam-output'), btnCopyCam:$('btn-copy-cam'),
    // titles
    inputTitle:$('input-title'), outputTitle:$('output-title')
  };

  /* ãƒ¢ãƒ¼ãƒ‰ */
  let mode='ENC';
  const tabState={ENC:{in:'',out:''}, DEC:{in:'',out:''}, FILE:{in:'',out:''}, B2F:{in:'',out:''},
                  CAM_B64:{in:'',out:''}, CAM_TXT:{in:'',out:''}, CAM_B64_MULTI:{in:'',out:''}, CAM_TXT_MULTI:{in:'',out:''}};
  const isCamMode = () => /^CAM_/.test(mode);
  const isTextCamMode = () => (mode==='CAM_TXT'||mode==='CAM_TXT_MULTI');
  const isMultiMode = () => (mode==='CAM_B64_MULTI'||mode==='CAM_TXT_MULTI');

  function setMode(to){
    tabState[mode].in = el.input?.value ?? '';
    tabState[mode].out = el.output?.value ?? '';
    mode = to;

    [el.mEnc,el.mDec,el.mFile,el.mB2F,el.mCamB64,el.mCamTxt,el.mCamB64M,el.mCamTxtM].forEach(b=>b.classList.remove('sel'));
    ({ENC:el.mEnc,DEC:el.mDec,FILE:el.mFile,B2F:el.mB2F,CAM_B64:el.mCamB64,CAM_TXT:el.mCamTxt,CAM_B64_MULTI:el.mCamB64M,CAM_TXT_MULTI:el.mCamTxtM})[mode].classList.add('sel');

    if (el.input)  el.input.value  = tabState[mode].in;
    if (el.output) el.output.value = tabState[mode].out;

    const isText = (mode==='ENC'||mode==='DEC');
    const isFile = (mode==='FILE');
    const isB2F  = (mode==='B2F');

    // å…¥å‡ºåŠ›è¡¨ç¤º
    el.panelInput.style.display  = (isText||isFile||isB2F) ? 'block' : 'none';
    el.panelOutput.style.display = isB2F ? 'none' : (isCamMode() ? 'none' : 'block');

    // ã‚¿ã‚¤ãƒˆãƒ«
    el.inputTitle.textContent  = isCamMode() ? 'ï¼ˆã‚«ãƒ¡ãƒ©ä½¿ç”¨æ™‚ã¯éè¡¨ç¤ºï¼‰' : 'å…¥åŠ›';
    el.outputTitle.textContent = 'å‡ºåŠ›';

    // å…¥åŠ›UIã®åˆ‡æ›¿
    el.input.style.display   = (isText||isB2F) ? 'block' : 'none';
    el.drop.style.display    = isFile ? 'flex' : 'none';
    el.textRow.style.display = isText ? 'flex' : 'none';
    el.b2fRow.style.display  = isB2F ? 'flex' : 'none';

    // QRé€å‡º
    el.qrSend.style.display  = (!isCamMode() && !isB2F) ? 'block' : 'none';

    // ã‚«ãƒ¡ãƒ©ã‚°ãƒªãƒƒãƒ‰
    el.camGrid.style.display = isCamMode() ? 'grid' : 'none';
    $('grid-opts').style.display = isMultiMode() ? 'flex' : 'none';

    // CAMå‡ºåŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ main output ã¨åŒä¸€ã«æ‰±ã†
    if (isCamMode()){
      el.camOutput.value = el.output.value;
    } else {
      el.output.value = isB2F ? '' : el.camOutput.value;
    }
  }

  /* Base64 utils */
  function utf8ToB64(str){
    if (window.TextEncoder){
      const bytes=new TextEncoder().encode(str); let bin=''; for(const b of bytes) bin+=String.fromCharCode(b); return btoa(bin);
    } else return btoa(unescape(encodeURIComponent(str)));
  }
  function normalizeB64(b64){
    let s=(b64||'').trim(); s=s.replace(/^data:.*;base64,/i,'').replace(/\s+/g,'').replace(/-/g,'+').replace(/_/g,'/');
    s+='='.repeat((4-(s.length%4))%4); return s;
  }
  function b64ToUtf8(b64){
    const clean=normalizeB64(b64); if(window.TextDecoder){ const bin=atob(clean); const bytes=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i); return new TextDecoder('utf-8').decode(bytes); }
    return decodeURIComponent(escape(atob(clean)));
  }

  /* å¤‰æ›ãƒ»ã‚³ãƒ”ãƒ¼ãƒ»ä¿å­˜ */
  function convert(){
    const s=el.input.value.trim(); if(!s){ alert('å…¥åŠ›ãŒç©ºã§ã™'); return; }
    try{ el.output.value = (mode==='ENC') ? utf8ToB64(s) : b64ToUtf8(s); }
    catch(e){ alert('å¤‰æ›ã«å¤±æ•—: '+e.message); }
  }
  async function pasteToInput(){
    try{ const t=await navigator.clipboard.readText(); if(!t){ alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒç©ºã§ã™'); return; } el.input.value=t; }
    catch{ alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰èª­ã¿å–ã‚ŠãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“'); }
  }
  function handleFiles(files){
    if(!files||!files.length) return;
    const f=files[0], r=new FileReader();
    r.onload=e=>{ const b64=(String(e.target.result).split(',')[1]||''); el.output.value=b64; };
    r.readAsDataURL(f);
  }
  function saveFile(){
    const b64=el.input.value.trim(); if(!b64){ alert('Base64ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    const name=(el.filename.value.trim()||'download'); const ext=el.filetype.value||'bin';
    const mime=({pdf:'application/pdf',docx:'application/vnd.openxmlformats-officedocument.wordprocessingml.document',xlsx:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',pptx:'application/vnd.openxmlformats-officedocument.presentationml.presentation',png:'image/png',jpg:'image/jpeg',mp4:'video/mp4',exe:'application/vnd.microsoft.portable-executable',bin:'application/octet-stream'})[ext]||'application/octet-stream';
    try{
      const clean=normalizeB64(b64); const bin=atob(clean); const arr=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
      const blob=new Blob([arr],{type:mime}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`${name}.${ext}`; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url),1500);
    }catch(e){ alert('ä¿å­˜ã«å¤±æ•—: '+e.message); }
  }
  async function copyOut(targetTA){
    const ta = targetTA || el.output;
    try{ await navigator.clipboard.writeText(ta.value||''); } catch { ta.select(); document.execCommand('copy'); window.getSelection().removeAllRanges(); }
  }

  /* QRé€å‡º */
  const fmtMMSS = x => { const t=Math.max(0,Math.floor(x)); const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return `${m}:${s}`; };
  const checksum = str => { let s=0; for(let i=0;i<str.length;i++) s=(s+str.charCodeAt(i))&0xffff; return s; };
  const FRAME_RE=/^\[(\d+)\/(\d+)\|(\d+)\]([\s\S]*)$/;

  let qrChunks=[], idx=0, playing=false, timer=null, fpsRate=1.0;
  function splitFrames(text, maxPayload){
    const total=Math.ceil(text.length/maxPayload)||1, frames=[];
    for(let i=0;i<total;i++){ const p=text.slice(i*maxPayload,(i+1)*maxPayload); frames.push(`[${i+1}/${total}|${checksum(p)}]${p}`); }
    return frames;
  }
  function splitFramesNoHeader(text,maxPayload){
    const total=Math.ceil(text.length/maxPayload)||1, frames=[];
    for(let i=0;i<total;i++) frames.push(text.slice(i*maxPayload,(i+1)*maxPayload));
    return frames;
  }
  function buildSequence(){
    const s=el.output.value.trim(); if(!s){ alert('å‡ºåŠ›ãŒç©ºã§ã™'); return false; }
    const maxPayload=700, withHeader=!el.noHdr.checked;
    qrChunks = withHeader ? splitFrames(s,maxPayload) : splitFramesNoHeader(s,maxPayload);
    idx=0; el.scrub.max=Math.max(qrChunks.length-1,0); el.scrub.value=0;
    renderQR(); updateTime(); return true;
  }
  function renderQR(){ el.qrWrap.innerHTML=''; const text=qrChunks[idx]||''; if(typeof QRCode==='undefined'){ alert('QRCodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'); return; } new QRCode(el.qrWrap,{text,width:320,height:320,correctLevel:QRCode.CorrectLevel.M}); el.frameInd.textContent=`${Math.min(idx+1,qrChunks.length)} / ${qrChunks.length}`; }
  function updateTime(){ const total=qrChunks.length; const dur=total/fpsRate; const cur=(idx+1)/fpsRate; el.elapsed.textContent=fmtMMSS(cur); el.duration.textContent=fmtMMSS(dur); }
  function play(){ if(playing||!qrChunks.length) return; playing=true; el.btnPlay.textContent='â¸'; tick(); }
  function pause(){ playing=false; el.btnPlay.textContent='â–¶'; if(timer){ clearTimeout(timer); timer=null; } }
  function tick(){ if(!playing) return; const interval=Math.max(1,Math.round(1000/fpsRate)); timer=setTimeout(()=>{ if(idx<qrChunks.length-1){ idx++; el.scrub.value=idx; renderQR(); updateTime(); tick(); } else { pause(); } }, interval); }
  function setFps(val){ let v=parseFloat(val); if(isNaN(v)) v=1; v=Math.min(120,Math.max(0.5,v)); fpsRate=v; el.fps.value=String(v); el.fpsNum.value=v.toFixed(1); updateTime(); if(playing){ pause(); play(); } }

  /* å—ä¿¡ï¼ˆã‚«ãƒ¡ãƒ©ï¼‰ */
  const rx = { total:0, got:new Map() };
  const rxTxt = { buffer:'' };
  let camStream=null, rafId=null;

  function appendHeaderedAndMaybeComplete(frame){
    const m=FRAME_RE.exec(String(frame).trim()); if(!m) return {matched:false};
    const i=parseInt(m[1],10), total=parseInt(m[2],10), sum=parseInt(m[3],10), payload=m[4];
    if (checksum(payload)!==sum) return {matched:true,ok:false};
    if (!rx.total) rx.total=total; if (rx.total!==total) return {matched:true,ok:false};
    const already = rx.got.has(i) && rx.got.get(i)===payload; rx.got.set(i,payload);
    el.rxStatus.textContent=`${rx.got.size}/${rx.total}`;
    if (already) return {matched:true,ok:true,complete:false};
    if (rx.got.size===rx.total){
      const parts=[]; for(let k=1;k<=rx.total;k++){ const p=rx.got.get(k); if(typeof p!=='string') return {matched:true,ok:false}; parts.push(p); }
      const joined=parts.join(''); rx.total=0; rx.got.clear(); el.rxStatus.textContent='0/0'; return {matched:true,ok:true,complete:true,payload:joined};
    }
    return {matched:true,ok:true,complete:false};
  }

  function ingestFrameToB64(text){
    const r=appendHeaderedAndMaybeComplete(text);
    if(!r.matched){ el.camOutput.value += text; }
    else if(r.complete){ el.camOutput.value = r.payload; }
  }
  function ingestFrameToText(text){
    const r=appendHeaderedAndMaybeComplete(text);
    if(!r.matched){ rxTxt.buffer += text; try{ el.camOutput.value = b64ToUtf8(rxTxt.buffer); }catch{} }
    else if(r.complete){ try{ el.camOutput.value = b64ToUtf8(r.payload); }catch{} }
  }

  const STABLE_FRAMES=2, DEDUPE_TTL_MS=8000;
  const seenHashes=new Map(); const camD={curr:'',same:0};
  function fp32(s){ let h=0x811c9dc5|0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h += (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24); } return h>>>0; }

  async function startScan(){
    if(typeof jsQR==='undefined'){ alert('jsQRãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
    if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){ alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©æœªå¯¾å¿œã§ã™'); return; }
    try{
      camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}},audio:false});
      el.cam.srcObject = camStream;
      await el.cam.play();
      ensureOverlaySize();
      if (rafId) cancelAnimationFrame(rafId);
      tickCam();
    }catch(e){ alert('ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—: '+e.message); }
  }
  function stopScan(){ if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; } if(rafId){ cancelAnimationFrame(rafId); rafId=null; } }
  function ensureOverlaySize(){
    const vw=el.cam.videoWidth||1280, vh=el.cam.videoHeight||720;
    const c=el.camOverlay; c.width=vw; c.height=vh;
    c.style.width = el.cam.clientWidth+'px'; c.style.height = el.cam.clientHeight+'px';
    drawOverlayGrid();
  }
  function drawOverlayGrid(){
    const ctx=el.camOverlay.getContext('2d');
    ctx.clearRect(0,0,el.camOverlay.width,el.camOverlay.height);
    if (!isMultiMode()) return;
    const rows=Math.max(1,Math.min(6,parseInt($('rows').value,10)||2));
    const cols=Math.max(1,Math.min(6,parseInt($('cols').value,10)||2));
    const w=el.camOverlay.width, h=el.camOverlay.height;
    ctx.strokeStyle='rgba(3,155,229,.95)'; ctx.lineWidth=2;
    for(let r=1;r<rows;r++){ const y=Math.round(h*r/rows)+.5; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
    for(let c=1;c<cols;c++){ const x=Math.round(w*c/cols)+.5; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
  }
  function drawDetections(dets){
    const ctx=el.camOverlay.getContext('2d');
    for(const d of dets){
      const pts=d.corners; ctx.save(); ctx.lineWidth=4; ctx.strokeStyle='rgba(16,185,129,0.95)'; ctx.beginPath();
      ctx.moveTo(pts[0].x,pts[0].y); for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x,pts[i].y); ctx.closePath(); ctx.stroke(); ctx.restore();
    }
  }
  function tickCam(){
    if(!camStream) return;
    const v=el.cam, c=el.camCanvas, ctx=c.getContext('2d');
    const w=v.videoWidth, h=v.videoHeight; if(!w||!h){ rafId=requestAnimationFrame(tickCam); return; }
    c.width=w; c.height=h;

    ctx.drawImage(v,0,0,w,h);
    const img=ctx.getImageData(0,0,w,h);
    const code=jsQR(img.data,img.width,img.height,{inversionAttempts:'dontInvert'});
    const dets=[];
    if (code && code.location){
      const L=code.location;
      dets.push({corners:[L.topLeftCorner,L.topRightCorner,L.bottomRightCorner,L.bottomLeftCorner]});
      const s = code.data;
      const m = FRAME_RE.exec(s);
      if (m){
        const i=parseInt(m[1],10), payload=m[4];
        const dup = rx.got.has(i) && rx.got.get(i)===payload;
        if (!dup){ isTextCamMode()?ingestFrameToText(s):ingestFrameToB64(s); }
        camD.curr=''; camD.same=0;
      }else{
        if (s===camD.curr) camD.same++; else { camD.curr=s; camD.same=1; }
        if (camD.same>=STABLE_FRAMES){
          const hsh=fp32(s), now=Date.now(), last=seenHashes.get(hsh)||0;
          if (now-last>DEDUPE_TTL_MS){
            if (isTextCamMode()){
              ingestFrameToText(s);
              if (el.autoStopHL.checked) stopScan();
            } else ingestFrameToB64(s);
            seenHashes.set(hsh,now); camD.same=0;
          }
        }
      }
    } else { camD.curr=''; camD.same=0; }

    // æç”»
    el.camOverlay.getContext('2d').clearRect(0,0,el.camOverlay.width,el.camOverlay.height);
    drawOverlayGrid(); drawDetections(dets);

    rafId=requestAnimationFrame(tickCam);
  }

  /* ã‚¤ãƒ™ãƒ³ãƒˆ */
  on(el.mEnc,'click',()=>setMode('ENC'));
  on(el.mDec,'click',()=>setMode('DEC'));
  on(el.mFile,'click',()=>setMode('FILE'));
  on(el.mB2F,'click',()=>setMode('B2F'));
  on(el.mCamB64,'click',()=>setMode('CAM_B64'));
  on(el.mCamTxt,'click',()=>setMode('CAM_TXT'));
  on(el.mCamB64M,'click',()=>setMode('CAM_B64_MULTI'));
  on(el.mCamTxtM,'click',()=>setMode('CAM_TXT_MULTI'));

  on(el.btnConvert,'click',convert);
  on(el.btnConvertQR,'click',()=>{ if(mode==='ENC'){ convert(); } if(mode==='FILE' && !el.output.value.trim()){ alert('å…ˆã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ/ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„'); return; } if(buildSequence()){ pause(); renderQR(); } });
  on(el.input,'keydown',e=>{
    if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); if(mode==='ENC'||mode==='DEC') convert(); }
    if(e.shiftKey && e.key==='Enter'){ e.preventDefault(); if(mode==='ENC'){ convert(); } if(mode==='FILE' && !el.output.value.trim()){ alert('å…ˆã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ/ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„'); return; } if(buildSequence()){ pause(); renderQR(); } }
  });

  on(el.btnCopy,'click',()=>copyOut(el.output));
  on(el.btnQR,'click',()=>{ if(buildSequence()){ pause(); renderQR(); } });

  // ãƒ†ã‚­ã‚¹ãƒˆç”¨ãƒšãƒ¼ã‚¹ãƒˆ/ã‚¯ãƒªã‚¢
  on(el.btnPasteTxt,'click',pasteToInput);
  on(el.btnClearTxt,'click',()=>{ el.input.value=''; el.input.focus(); });

  // B2Fè¡Œ
  on(el.btnPaste,'click',pasteToInput);
  on(el.btnClear,'click',()=>{ el.input.value=''; el.input.focus(); });
  on(el.btnSave,'click',saveFile);

  // ãƒ•ã‚¡ã‚¤ãƒ«â†’B64
  on(el.fileBtn,'click',()=>el.fileInput.click());
  on(el.fileInput,'change',()=>handleFiles(el.fileInput.files));
  on(el.drop,'dragover',e=>{ e.preventDefault(); el.drop.classList.add('hover'); });
  on(el.drop,'dragleave',()=>el.drop.classList.remove('hover'));
  on(el.drop,'drop',e=>{ e.preventDefault(); el.drop.classList.remove('hover'); handleFiles(e.dataTransfer.files); });

  // QRé€å‡ºæ“ä½œ
  on(el.btnPrev,'click',()=>{ if(idx>0){ idx--; el.scrub.value=idx; renderQR(); updateTime(); } });
  on(el.btnNext,'click',()=>{ if(idx<qrChunks.length-1){ idx++; el.scrub.value=idx; renderQR(); updateTime(); } });
  on(el.btnPlay,'click',()=> playing?pause():play());
  on(el.scrub,'input',()=>{ idx=parseInt(el.scrub.value||'0',10)||0; renderQR(); updateTime(); });
  on(el.fps,'input',()=>setFps(el.fps.value));
  on(el.fpsNum,'input',()=>setFps(el.fpsNum.value));
  on(el.fpsNum,'change',()=>setFps(el.fpsNum.value));

  // ã‚«ãƒ¡ãƒ©
  on(el.btnScanStart,'click',startScan);
  on(el.btnScanStop,'click',stopScan);
  el.cam.addEventListener('loadedmetadata', ensureOverlaySize);
  window.addEventListener('resize', ensureOverlaySize);
  ['rows','cols','roi-margin'].forEach(id=> on($(id),'input',drawOverlayGrid));

  // CAMå‡ºåŠ›ã®ã‚³ãƒ”ãƒ¼
  on(el.btnCopyCam,'click',()=>copyOut(el.camOutput));

  // ãƒ˜ãƒ«ãƒ—
  const HELP_MAIL='suzuki.yuya.kitasato@gmail.com';
  const help={
    modal:$('help-modal'), btnOpen:$('btn-help'), btnClose:$('btn-help-close'),
    btnPrint:$('btn-help-print'), qrBox:$('help-qr'), version:$('about-version')
  };
  function openHelp(){
    help.modal.classList.add('show'); help.modal.setAttribute('aria-hidden','false');
    if(help.qrBox && !help.qrBox.dataset.ready && typeof QRCode!=='undefined'){
      help.qrBox.innerHTML=''; new QRCode(help.qrBox,{text:HELP_MAIL,width:110,height:110,correctLevel:QRCode.CorrectLevel.M});
      help.qrBox.dataset.ready='1';
    }
    help.version.textContent = `${APP_VERSION}ï¼ˆãƒ“ãƒ«ãƒ‰: ${APP_BUILD}ï¼‰`;
  }
  function closeHelp(){ help.modal.classList.remove('show'); help.modal.setAttribute('aria-hidden','true'); }
  on(help.btnOpen,'click',openHelp);
  on(help.btnClose,'click',closeHelp);
  on(help.btnPrint,'click',()=>window.print());
  help.modal.addEventListener('click', (e)=>{ if(e.target===help.modal) closeHelp(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeHelp(); });

  // åˆæœŸåŒ–
  setMode('ENC');
  setFps(el.fps.value);
});
</script>
</body>
</html>
