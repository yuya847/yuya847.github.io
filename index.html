<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>QR B64ãƒ–ãƒªãƒƒã‚¸</title>

<!-- Favicon / iOS -->
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="/apple-touch-icon-180.png" sizes="180x180">
<meta name="theme-color" content="#0d47a1">

<!-- Material Symbols (Outlined) -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24..48,400,0,0" rel="stylesheet" />

<style>
/* ========== Theme (Material palette you specified) ========== */
:root{
  --fg:#222;
  --bg:#fff;
  --muted:#666;
  --br:#ddd;
  --pri:#0d47a1;   /* primary deep blue */
  --acc:#039be5;   /* accent blue (used for secondary) */
  --ok:#81d4fa;    /* light info for neutral action */
  --err:#d32f2f;   /* danger */
  --surface:#eceff1;
}

html,body{height:100%}
body{
  margin:0;
  font-family:Meiryo,"Yu Gothic",sans-serif;
  color:var(--fg);
  background:var(--bg);
  display:flex; flex-direction:column;
}

/* ========== Header ========== */
header{background:#2d2d2d;color:#fff;padding:12px 16px}
.header-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
h1{margin:0;font-size:16px;display:flex;align-items:center;gap:10px}
.logo{width:22px;height:22px;display:inline-block}
.header-actions{display:flex;align-items:center;gap:8px}
.badge{display:inline-block;background:#444;color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #666}

/* ========== Container ========== */
.container{padding:12px;display:flex;flex-direction:column;gap:12px}

/* ========== Material Buttons ========== */
button,select,input[type="text"],input[type="file"],input[type="number"]{
  font-size:15px; padding:8px 12px; border:1px solid #bbb; border-radius:8px; background:#fff;
}
button{
  cursor:pointer; border:none;
  transition:background-color .15s ease,transform .06s ease,box-shadow .15s ease,filter .15s ease;
}
button:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 2px 8px rgb(0 0 0 / .12);filter:brightness(1.03)}
button:active:not(:disabled){transform:translateY(0);box-shadow:0 1px 3px rgb(0 0 0 / .20);filter:brightness(0.95)}
button:focus-visible{outline:3px solid var(--acc);outline-offset:2px}
button:disabled{opacity:.6;cursor:default}
.btn-primary{background:var(--pri);color:#fff}
.btn-secondary{background:var(--acc);color:#fff}
.btn-neutral{background:var(--ok);color:#0d47a1;border:1px solid #bde4ff}
.btn-danger{background:var(--err);color:#fff}
.btn-surface{background:var(--surface);color:#222;border:1px solid #cfd8dc}

/* ripple (light) */
button.ripple{
  --ripple-x:50%;--ripple-y:50%;--ripple-color:rgba(255,255,255,.35);
  background-image:radial-gradient(circle at var(--ripple-x) var(--ripple-y),var(--ripple-color) 0,var(--ripple-color) 10%,transparent 11%);
  background-repeat:no-repeat;background-size:0 0
}
button.rippling{background-size:200% 200%}

/* ========== Mode Segments ========== */
.mode{display:flex;gap:8px;flex-wrap:wrap}
.seg{
  display:flex; gap:8px; padding:8px;
  border:1px solid var(--br); border-radius:12px; flex-wrap:wrap;
  background:#fff;
}
.seg button{
  display:flex; align-items:center; gap:8px;
  padding:10px 12px; border:1px solid var(--br); border-radius:999px; background:#fff; color:#222;
}
.seg button.sel{background:#e3e6ed;color:#111;font-weight:700;border-color:#888}
.seg button .short{display:none}
.seg button .full{display:inline}
.muted{color:var(--muted);font-size:13px}

/* icons */
.ms{font-family:"Material Symbols Outlined"; font-weight:400; font-style:normal; font-size:1.2em; line-height:1; display:inline-block; vertical-align:-0.15em;}
/* QRs: two qrs overlapped, 0.66 scale for the front one */
.icon-qr2{position:relative; width:1.2em; height:1.2em; display:inline-block}
.icon-qr2 .ms{position:absolute; left:0; top:0}
.icon-qr2 .ms.base{transform:scale(1)}
.icon-qr2 .ms.top{transform:scale(0.66); transform-origin:bottom right; left:.45em; top:.15em; opacity:.95}

/* tooltip bubbles (small) */
[data-tip]{position:relative}
[data-tip]::after{
  content:attr(data-tip);
  position:absolute; left:50%; transform:translateX(-50%);
  bottom:calc(100% + 8px);
  background:rgba(0,0,0,.82); color:#fff; font-size:12px; padding:4px 8px; border-radius:6px; white-space:nowrap;
  opacity:0; pointer-events:none; transition:opacity .12s; z-index:30;
}
[data-tip]::before{
  content:""; position:absolute; left:50%; transform:translateX(-50%);
  bottom:100%;
  border:6px solid transparent; border-top-color:rgba(0,0,0,.82);
  opacity:0; transition:opacity .12s; z-index:30;
}
[data-tip]:hover::after,[data-tip]:hover::before{opacity:1}

/* ========== Panels & Grid ========== */
.grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
@media(max-width:900px){ .grid{grid-template-columns:1fr} }
.panel{border:1px solid var(--br);border-radius:8px;padding:12px;background:#fff;display:flex;flex-direction:column;gap:8px}
.panel h2{margin:0;font-size:15px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.row.right{justify-content:flex-end}
.row.between{justify-content:space-between; align-items:center}

/* textarea */
textarea{
  width:100%; min-height:220px; resize:vertical; font-size:16px; line-height:1.5;
  padding:10px; border:1px solid #ccc; border-radius:8px; box-sizing:border-box;
}

/* big drop zone for FILE->B64 */
#drop-zone{display:none; border:2px dashed #aaa; border-radius:10px; min-height:230px;
  align-items:center; justify-content:center; text-align:center; padding:20px; color:#666; background:#fafafa}
#drop-zone.hover{background:#eef}

/* input-side tool rows */
.tool-left, .tool-right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

/* QR send area */
.qr-wrap{display:flex;align-items:center;justify-content:center;height:340px;background:#fff;border:1px solid #eee;border-radius:8px;overflow:hidden}
.qr-controls{display:flex;flex-direction:column;gap:10px}
.qr-scrub{display:flex;align-items:center;gap:8px}
.qr-bottom{display:flex;align-items:center;gap:12px;justify-content:center;flex-wrap:wrap}
.time{min-width:60px;text-align:right;font-variant-numeric:tabular-nums}
.range{flex:1}
.nohdr{display:flex;align-items:center;gap:6px;margin-left:12px}
.nohdr.small{opacity:.7; font-size:12px} /* ç›®ç«‹ãŸã›ãªã„æŒ‡å®š */

/* Camera */
.cam-wrap{display:flex;flex-direction:column;gap:10px}
.video-box{position:relative}
video#cam{width:100%;max-height:320px;background:#000;border-radius:8px;display:block}
canvas.overlay{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}

/* Mode brief (èª¬æ˜) */
#mode-brief{border:1px dashed #cfd8dc; border-radius:10px; padding:12px; background:#f7fbff}

/* Help footer */
footer.help{margin-top:20px; padding:18px 12px; background:#fafafa; border-top:1px solid #e5e7eb}
.help-grid{display:grid; grid-template-columns:1.2fr .8fr; gap:16px}
@media(max-width:900px){ .help-grid{grid-template-columns:1fr} }
.qr-cell{width:120px;height:120px;border:1px solid #eee;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#fff}

/* mobile: show 4x2 always for mode buttons */
@media (max-width:1200px){
  .seg{display:grid; grid-template-columns:repeat(4,minmax(0,1fr))}
  .seg button{justify-content:center}
}
@media (max-width:640px){
  .seg button{font-size:12px; padding:8px 8px}
  .seg button .full{display:none}
  .seg button .short{display:inline}
}

/* Accessibility & motion */
@media (prefers-reduced-motion: reduce){*{transition:none !important;animation:none !important}}
</style>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js" defer></script>
</head>

<body>
<header>
  <div class="header-row">
    <h1><img class="logo" src="/favicon.svg" alt="">ãƒ†ã‚­ã‚¹ãƒˆQRã‚³ãƒ¼ãƒ‰å¤‰æ›</h1>
    <div class="header-actions">
      <span id="ver" class="badge" title="ãƒãƒ¼ã‚¸ãƒ§ãƒ³"></span>
      <!-- ãƒ˜ãƒ«ãƒ—ã‚’ãƒšãƒ¼ã‚¸ä¸‹ã«æˆ»ã—ãŸã®ã§ã€ã“ã“ã¯ä¸‹éƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« -->
      <button id="btn-goto-help" class="btn-surface ripple" data-tip="ãƒšãƒ¼ã‚¸ä¸‹ã®ãƒ˜ãƒ«ãƒ—ã¸">ãƒ˜ãƒ«ãƒ—</button>
    </div>
  </div>
</header>

<div class="container">

  <!-- ========== Mode (8 round buttons) ========== -->
  <div class="mode">
    <div class="seg" role="tablist" aria-label="mode">
      <!-- ãƒ†ã‚­ã‚¹ãƒˆâ†’Base64 -->
      <button id="m-enc" class="sel ripple" role="tab" data-tip="ãƒ†ã‚­ã‚¹ãƒˆâ†’Base64">
        <span class="ms">text_ad</span>
        <span class="full">ãƒ†ã‚­ã‚¹ãƒˆ â†’ Base64</span><span class="short">Textâ†’B64</span>
      </button>
      <!-- Base64â†’ãƒ†ã‚­ã‚¹ãƒˆ -->
      <button id="m-dec" class="ripple" role="tab" data-tip="Base64â†’ãƒ†ã‚­ã‚¹ãƒˆ">
        <span class="ms">text_ad</span>
        <span class="full">Base64 â†’ ãƒ†ã‚­ã‚¹ãƒˆ</span><span class="short">B64â†’Text</span>
      </button>
      <!-- ãƒ•ã‚¡ã‚¤ãƒ«â†’Base64 -->
      <button id="m-file" class="ripple" role="tab" data-tip="ãƒ•ã‚¡ã‚¤ãƒ«â†’Base64">
        <span class="ms">insert_drive_file</span>
        <span class="full">ãƒ•ã‚¡ã‚¤ãƒ« â†’ Base64</span><span class="short">ğŸ“â†’B64</span>
      </button>
      <!-- Base64â†’ãƒ•ã‚¡ã‚¤ãƒ« -->
      <button id="m-b2f" class="ripple" role="tab" data-tip="Base64â†’ãƒ•ã‚¡ã‚¤ãƒ«">
        <span class="ms">save_as</span>
        <span class="full">Base64 â†’ ãƒ•ã‚¡ã‚¤ãƒ«</span><span class="short">B64â†’ğŸ“</span>
      </button>
      <!-- QRâ†’Base64 -->
      <button id="m-cam" class="ripple" role="tab" data-tip="QRâ†’Base64">
        <span class="ms">qr_code_2</span>
        <span class="full">QRâ†’Base64</span><span class="short">QRâ†’B64</span>
      </button>
      <!-- QRâ†’ãƒ†ã‚­ã‚¹ãƒˆ -->
      <button id="m-camtxt" class="ripple" role="tab" data-tip="QRâ†’ãƒ†ã‚­ã‚¹ãƒˆ">
        <span class="ms">qr_code_2</span>
        <span class="full">QRâ†’ãƒ†ã‚­ã‚¹ãƒˆ</span><span class="short">QRâ†’Text</span>
      </button>
      <!-- QRsâ†’Base64ï¼ˆäºŒé‡QR 0.66xï¼‰ -->
      <button id="m-cam-multi" class="ripple" role="tab" data-tip="QRè¤‡æ•°â†’Base64">
        <span class="icon-qr2" aria-hidden="true">
          <span class="ms base">qr_code_2</span>
          <span class="ms top">qr_code_2</span>
        </span>
        <span class="full">QRè¤‡æ•°â†’Base64</span><span class="short">QRsâ†’B64</span>
      </button>
      <!-- QRsâ†’ãƒ†ã‚­ã‚¹ãƒˆ -->
      <button id="m-camtxt-multi" class="ripple" role="tab" data-tip="QRè¤‡æ•°â†’ãƒ†ã‚­ã‚¹ãƒˆ">
        <span class="icon-qr2" aria-hidden="true">
          <span class="ms base">qr_code_2</span>
          <span class="ms top">qr_code_2</span>
        </span>
        <span class="full">QRè¤‡æ•°â†’ãƒ†ã‚­ã‚¹ãƒˆ</span><span class="short">QRsâ†’Text</span>
      </button>
    </div>
  </div>

  <!-- ========== Mode Brief (ç•ªå·ãªã—ã®ç°¡å˜èª¬æ˜) ========== -->
  <div id="mode-brief" class="muted">æ–‡ç« ã‚’Base64ã¨ã„ã†æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¾ã™ã€‚Base64ã‚’ä»‹ã—ã¦QRã‚³ãƒ¼ãƒ‰ã«å¤‰æ›å¯èƒ½ã§ã™ã€‚é›»å­ã‚«ãƒ«ãƒ†ã«ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ãƒ¡ãƒ¢ã—ãŸæ–‡ç« ã‚’å…¥åŠ›ã—ãŸã„ã¨ããªã©ä¾¿åˆ©ã§ã™ã€‚</div>

  <!-- ========== I/O grid ========== -->
  <div class="grid" id="text-io">

    <!-- å…¥åŠ› -->
    <section class="panel" id="panel-input">
      <h2>å…¥åŠ›</h2>

      <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› -->
      <textarea id="input" placeholder="ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯Base64ã‚’å…¥åŠ›â€¦"></textarea>

      <!-- FILEâ†’B64 ã§ã¯ã“ã¡ã‚‰ã‚’å¤§ããè¡¨ç¤º -->
      <div id="drop-zone">
        <div>
          <div class="ms" style="font-size:28px;display:block;margin-bottom:8px">file_upload</div>
          ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯
          <button id="btn-file-choose" class="btn-surface ripple" data-tip="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ">ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</button>
          <input id="file-input" type="file" style="display:none"/>
        </div>
      </div>

      <!-- B2F ç”¨ãƒ„ãƒ¼ãƒ«è¡Œï¼ˆå·¦ï¼šãƒšãƒ¼ã‚¹ãƒˆ/ã‚¯ãƒªã‚¢ã€å³ï¼šãƒ•ã‚¡ã‚¤ãƒ«å/æ‹¡å¼µå­/ä¿å­˜ï¼‰ -->
      <div id="row-b2f-tools" class="row between" style="display:none">
        <div class="tool-left">
          <button id="btn-paste" class="btn-neutral ripple" data-tip="ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚’ãƒšãƒ¼ã‚¹ãƒˆ">
            <span class="ms">content_paste</span> ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚’ãƒšãƒ¼ã‚¹ãƒˆ
          </button>
          <button id="btn-clear" class="btn-surface ripple" data-tip="å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢">
            <span class="ms">delete</span> ã‚¯ãƒªã‚¢
          </button>
        </div>
        <div class="tool-right">
          <input id="filename" type="text" placeholder="ä¿å­˜æ™‚ã®ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæ‹¡å¼µå­ãªã—ï¼‰" style="min-width:200px">
          <label>å½¢å¼
            <select id="filetype">
              <option value="pdf">PDF</option>
              <option value="docx">Word (.docx)</option>
              <option value="xlsx">Excel (.xlsx)</option>
              <option value="pptx">PowerPoint (.pptx)</option>
              <option value="png">PNG</option>
              <option value="jpg">JPEG</option>
              <option value="mp4">MP4</option>
              <option value="exe">EXE</option>
              <option value="bin">ãƒã‚¤ãƒŠãƒª (.bin)</option>
            </select>
          </label>
          <button id="btn-save" class="btn-secondary ripple" data-tip="åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜">
            <span class="ms">save_as</span> åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜
          </button>
        </div>
      </div>

      <!-- ãƒ†ã‚­ã‚¹ãƒˆç³»ãƒ¢ãƒ¼ãƒ‰ã®ãƒ„ãƒ¼ãƒ«è¡Œ -->
      <div id="row-text-tools" class="row right">
        <button id="btn-convert" class="btn-primary ripple" data-tip="å¤‰æ›ï¼ˆCtrl+Enterï¼‰">å¤‰æ›ï¼ˆCtrl+Enterï¼‰</button>
        <button id="btn-convert-qr" class="btn-secondary ripple" data-tip="å¤‰æ›ï¼‹QRã‚’è¡¨ç¤ºï¼ˆShift+Enterï¼‰">å¤‰æ›ï¼‹QRã‚’è¡¨ç¤ºï¼ˆShift+Enterï¼‰</button>
        <button id="btn-paste-text" class="btn-neutral ripple" data-tip="ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚’ãƒšãƒ¼ã‚¹ãƒˆ">
          <span class="ms">content_paste</span>
        </button>
        <button id="btn-clear-text" class="btn-surface ripple" data-tip="å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢">
          <span class="ms">delete</span>
        </button>
      </div>
    </section>

    <!-- å‡ºåŠ› -->
    <section class="panel" id="panel-output">
      <h2>å‡ºåŠ›</h2>
      <textarea id="output" placeholder="ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
      <div class="row" id="row-output-actions">
        <button id="btn-copy" class="btn-secondary ripple" data-tip="ã‚³ãƒ”ãƒ¼">
          <span class="ms">content_copy</span> ã‚³ãƒ”ãƒ¼
        </button>
        <button id="btn-qrshow" class="btn-secondary ripple" data-tip="QRã‚’é€£ç¶šè¡¨ç¤º">
          <span class="ms">qr_code_2</span> QRè¡¨ç¤ºï¼ˆé€£ç¶šï¼‰
        </button>
      </div>
    </section>

  </div><!-- /grid -->

  <!-- é€ä¿¡ç”¨QRï¼ˆãƒ†ã‚­ã‚¹ãƒˆç³»ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰ -->
  <section class="panel" id="qr-send">
    <h2>QRã‚·ãƒ¼ã‚±ãƒ³ã‚¹å‡ºåŠ›</h2>
    <div class="qr-controls">
      <div class="qr-wrap" id="qr-display"></div>
      <div class="qr-scrub">
        <span id="elapsed" class="time">00:00</span>
        <input id="scrub" class="range" type="range" min="0" max="0" step="1" value="0"/>
        <span id="duration" class="time">00:00</span>
        <span id="frame-ind" class="muted">0 / 0</span>
      </div>
      <div class="qr-bottom">
        <button id="btn-prev" class="btn-surface ripple" data-tip="å‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ ">â®</button>
        <button id="btn-play" class="btn-secondary ripple" data-tip="å†ç”Ÿ / ä¸€æ™‚åœæ­¢">â–¶</button>
        <button id="btn-next" class="btn-surface ripple" data-tip="æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ">â­</button>
        <label class="nohdr small" data-tip="ãƒ˜ãƒƒãƒ€ã‚’ä»˜ã‘ãšã«é€ã‚‹ï¼ˆEMRç›´è²¼ã‚Šå‘ã‘ï¼‰">
          <input id="no-header" type="checkbox" checked> ãƒ˜ãƒƒãƒ€ãªã—ï¼ˆé›»å­ã‚«ãƒ«ãƒ†å‘ã‘ï¼‰
        </label>
      </div>
    </div>
  </section>

  <!-- å—ä¿¡ï¼šã‚«ãƒ¡ãƒ©ï¼ˆHIDã¯å‰Šé™¤ï¼‰ -->
  <section class="panel" id="qr-recv" style="display:none">
    <h2>QRå…¥åŠ›</h2>
    <div class="cam-wrap">
      <div class="row">
        <button id="btn-scan-start" class="btn-secondary ripple" data-tip="ã‚«ãƒ¡ãƒ©é–‹å§‹ï¼ˆQRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠï¼‰">
          <span class="ms">qr_code_scanner</span> ã‚«ãƒ¡ãƒ©é–‹å§‹
        </button>
        <button id="btn-scan-stop" class="btn-danger ripple" data-tip="åœæ­¢">
          <span class="ms">stop_circle</span> åœæ­¢
        </button>
      </div>

      <!-- ãƒ˜ãƒƒãƒ€ãªã—ä¸€æšã§è‡ªå‹•åœæ­¢ï¼ˆã‚ã¾ã‚Šç›®ç«‹ãŸã›ãªã„ï¼‰ -->
      <div class="row" id="auto-stop-wrap" style="display:none">
        <label class="nohdr small" data-tip="ãƒ˜ãƒƒãƒ€ç„¡ã—ã®ã¨ã1æšèª­ã‚“ã ã‚‰è‡ªå‹•åœæ­¢ï¼ˆèª¤è¿½è¨˜é˜²æ­¢ï¼‰">
          <input id="auto-stop-hl" type="checkbox"> ãƒ˜ãƒƒãƒ€ãªã—ã¯1æšèª­ã‚“ã ã‚‰è‡ªå‹•åœæ­¢ï¼ˆQRâ†’ãƒ†ã‚­ã‚¹ãƒˆï¼‰
        </label>
      </div>

      <!-- è¤‡æ•°ROI -->
      <div class="row" id="grid-opts" style="display:none">
        <label>è¡Œ: <input id="rows" type="number" min="1" max="6" value="2"></label>
        <label>åˆ—: <input id="cols" type="number" min="1" max="6" value="2"></label>
        <label>ROIä½™ç™½(px): <input id="roi-margin" type="number" min="0" max="80" value="16"></label>
        <span class="muted">é›»å­ã‚«ãƒ«ãƒ†å´ã®ãƒã‚¹æ•°ã«åˆã‚ã›ã¦ãã ã•ã„ï¼ˆä¾‹: 2Ã—2ï¼‰ã€‚</span>
      </div>

      <div class="video-box">
        <video id="cam" playsinline muted></video>
        <canvas id="cam-overlay" class="overlay"></canvas>
      </div>
      <canvas id="cam-canvas" style="display:none"></canvas>

      <div class="muted">å—ä¿¡é€²æ—ï¼ˆãƒ˜ãƒƒãƒ€ä»˜ãæ™‚ï¼‰: <span id="rx-status">0/0</span></div>
    </div>
  </section>
</div><!-- /container -->

<!-- ========== ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆãƒšãƒ¼ã‚¸ä¸‹ã«ãƒ˜ãƒ«ãƒ—ã‚’æˆ»ã™ï¼‰ ========== -->
<footer class="help" id="help">
  <div class="help-grid">
    <section>
      <h3>ä½¿ã„æ–¹</h3>
      <ul>
        <li><b>ãƒ†ã‚­ã‚¹ãƒˆ â†’ Base64</b>ï¼šæ–‡ç« ã‚’Base64ã¨ã„ã†æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¾ã™ã€‚Base64ã‚’ä»‹ã—ã¦QRã‚³ãƒ¼ãƒ‰ã«å¤‰æ›å¯èƒ½ã§ã™ã€‚é›»å­ã‚«ãƒ«ãƒ†ã«ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ãƒ¡ãƒ¢ã—ãŸæ–‡ç« ã‚’å…¥åŠ›ã—ãŸã„ã¨ããªã©ä¾¿åˆ©ã§ã™ã€‚</li>
        <li><b>Base64 â†’ ãƒ†ã‚­ã‚¹ãƒˆ</b>ï¼šé›»å­ã‚«ãƒ«ãƒ†ã‹ã‚‰ã‚¹ã‚­ãƒ£ãƒ³ã—ãŸBase64æ–‡å­—åˆ—ã‚’æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã«å¾©å…ƒã—ã¾ã™ã€‚</li>
        <li><b>ãƒ•ã‚¡ã‚¤ãƒ« â†’ Base64</b>ï¼šä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›ã—ã¾ã™ã€‚QRåŒ–ã™ã‚Œã°ç”»åƒã€PDFã€Excelãªã©ã‚’é›»å­ã‚«ãƒ«ãƒ†ã¸å…¥åŠ›ã§ãã¾ã™ã€‚</li>
        <li><b>Base64 â†’ ãƒ•ã‚¡ã‚¤ãƒ«</b>ï¼šå—ã‘å–ã£ãŸBase64ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æˆ»ã—ã¾ã™ã€‚</li>
        <li><b>QR â†’ Base64</b>ï¼šQRã‚³ãƒ¼ãƒ‰ã‚’Base64ã¨ã—ã¦å—ä¿¡ã—ã¾ã™ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å—ã‘å–ã‚Šå‘ã‘ï¼‰ã€‚</li>
        <li><b>QR â†’ ãƒ†ã‚­ã‚¹ãƒˆ</b>ï¼šQRã‚³ãƒ¼ãƒ‰ã‹ã‚‰ç›´æ¥ãƒ†ã‚­ã‚¹ãƒˆã¸å¾©å…ƒã—ã¾ã™ã€‚</li>
        <li><b>QRè¤‡æ•° â†’ Base64 / ãƒ†ã‚­ã‚¹ãƒˆ</b>ï¼šæ˜ åƒã‚’ã‚°ãƒªãƒƒãƒ‰åˆ†å‰²ã—ã¦è¤‡æ•°åŒæ™‚èª­ã¿å–ã‚Šã€‚ç†è«–ä¸Šã€å˜ä¸€QRã‚ˆã‚Šé«˜é€Ÿã§ã™ã€‚</li>
      </ul>
    </section>

    <section>
      <h3>ãŠå•ã„åˆã‚ã›</h3>
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <div id="help-qr" class="qr-cell" aria-label="é€£çµ¡å…ˆQR"></div>
        <div>
          <div><strong>ãƒ¡ãƒ¼ãƒ«:</strong> <a href="mailto:suzuki.yuya.kitasato@gmail.com">suzuki.yuya.kitasato@gmail.com</a></div>
          <button id="btn-copy-mail" class="btn-surface ripple" data-tip="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚³ãƒ”ãƒ¼">
            <span class="ms">content_copy</span> ã‚³ãƒ”ãƒ¼
          </button>
        </div>
      </div>
      <div class="muted" style="margin-top:10px">Â© Yuya Suzuki, Okazaki Medical Center</div>
      <div class="muted" style="margin-top:6px"><span id="about-version"></span></div>
    </section>
  </div>
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
'use strict';

/* ===== Version ===== */
const APP_VERSION='ver 1.3';
const APP_BUILD='2025-08-10';
const $=id=>document.getElementById(id);
const on=(n,e,f)=>n&&n.addEventListener(e,f,false);
$('ver').textContent=APP_VERSION;
$('about-version').textContent=`${APP_VERSION}ï¼ˆãƒ“ãƒ«ãƒ‰: ${APP_BUILD}ï¼‰`;

/* ===== Elements ===== */
const el={
  // tabs
  mEnc:$('m-enc'), mDec:$('m-dec'), mFile:$('m-file'), mB2F:$('m-b2f'),
  mCamB64:$('m-cam'), mCamTxt:$('m-camtxt'), mCamB64M:$('m-cam-multi'), mCamTxtM:$('m-camtxt-multi'),
  // desc
  brief:$('mode-brief'),
  // grid/panels
  textIO:$('text-io'), panelInput:$('panel-input'), panelOutput:$('panel-output'),
  // widgets
  input:$('input'), output:$('output'),
  drop:$('drop-zone'), fileBtn:$('btn-file-choose'), fileInput:$('file-input'),
  fileRow:$('row-b2f-tools'),
  textRow:$('row-text-tools'),
  btnPaste:$('btn-paste'), btnClear:$('btn-clear'),
  btnPasteText:$('btn-paste-text'), btnClearText:$('btn-clear-text'),
  filename:$('filename'), filetype:$('filetype'), btnSave:$('btn-save'),
  btnCopy:$('btn-copy'), btnQR:$('btn-qrshow'),
  btnConvert:$('btn-convert'), btnConvertQR:$('btn-convert-qr'),
  // send
  qrSend:$('qr-send'), qrWrap:$('qr-display'), scrub:$('scrub'),
  elapsed:$('elapsed'), duration:$('duration'), frameInd:$('frame-ind'),
  btnPrev:$('btn-prev'), btnPlay:$('btn-play'), btnNext:$('btn-next'),
  noHdr:$('no-header'),
  // recv
  qrRecv:$('qr-recv'), cam:$('cam'), camCanvas:$('cam-canvas'), camOv:$('cam-overlay'),
  btnScanStart:$('btn-scan-start'), btnScanStop:$('btn-scan-stop'),
  rxStatus:$('rx-status'),
  // multi options
  autoStopWrap:$('auto-stop-wrap'), autoStopHL:$('auto-stop-hl'),
  gridOpts:$('grid-opts'), rows:$('rows'), cols:$('cols'), roiMargin:$('roi-margin'),
};

/* ===== Mode brief texts (numbers removed) ===== */
const briefText={
  ENC:'æ–‡ç« ã‚’Base64ã¨ã„ã†æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¾ã™ã€‚Base64ã‚’ä»‹ã—ã¦QRã‚³ãƒ¼ãƒ‰ã«å¤‰æ›å¯èƒ½ã§ã™ã€‚é›»å­ã‚«ãƒ«ãƒ†ã«ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ãƒ¡ãƒ¢ã—ãŸæ–‡ç« ã‚’å…¥åŠ›ã—ãŸã„ã¨ããªã©ä¾¿åˆ©ã§ã™ã€‚',
  DEC:'é›»å­ã‚«ãƒ«ãƒ†ã‹ã‚‰ã‚¹ã‚­ãƒ£ãƒ³ã—ãŸBase64æ–‡å­—åˆ—ã‚’æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã«å¾©å…ƒã—ã¾ã™ã€‚',
  FILE:'ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›ã—ã¾ã™ã€‚QRåŒ–ã™ã‚Œã°ç”»åƒã€PDFã€Excelãªã©ã‚’é›»å­ã‚«ãƒ«ãƒ†ã¸å…¥åŠ›ã§ãã¾ã™ã€‚',
  B2F:'å—ã‘å–ã£ãŸBase64ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æˆ»ã—ã¾ã™ã€‚',
  CAM_B64:'QRã‚³ãƒ¼ãƒ‰ã‚’Base64ã¨ã—ã¦å—ä¿¡ã—ã¾ã™ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å—ã‘å–ã‚Šå‘ã‘ï¼‰ã€‚',
  CAM_TXT:'QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰ç›´æ¥ãƒ†ã‚­ã‚¹ãƒˆã¸å¾©å…ƒã—ã¾ã™ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å—ã‘å–ã‚Šã«ã¯ä¸å‘ãï¼‰ã€‚',
  CAM_B64_MULTI:'æ˜ åƒã‚’ã‚°ãƒªãƒƒãƒ‰åˆ†å‰²ã—ã€è¤‡æ•°ã®QRã‹ã‚‰Base64ã‚’åŒæ™‚å—ä¿¡ã—ã¾ã™ï¼ˆé«˜é€Ÿï¼‰ã€‚',
  CAM_TXT_MULTI:'æ˜ åƒã‚’ã‚°ãƒªãƒƒãƒ‰åˆ†å‰²ã—ã€è¤‡æ•°ã®QRã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’åŒæ™‚å—ä¿¡ã—ã¾ã™ï¼ˆé«˜é€Ÿï¼‰ã€‚'
};

/* ===== State & helpers ===== */
let mode='ENC';
const tabState={
  ENC:{in:'',out:''}, DEC:{in:'',out:''}, FILE:{in:'',out:''}, B2F:{in:'',out:''},
  CAM_B64:{in:'',out:''}, CAM_TXT:{in:'',out:''}, CAM_B64_MULTI:{in:'',out:''}, CAM_TXT_MULTI:{in:'',out:''}
};
const isCamMode=()=>/^CAM_/.test(mode);
const isMultiMode=()=>mode==='CAM_B64_MULTI'||mode==='CAM_TXT_MULTI';
const isTextCam=()=>mode==='CAM_TXT'||mode==='CAM_TXT_MULTI';

function setMode(to){
  // keep values
  tabState[mode].in  = el.input?.value ?? '';
  tabState[mode].out = el.output?.value ?? '';
  mode=to;

  // sel
  [el.mEnc,el.mDec,el.mFile,el.mB2F,el.mCamB64,el.mCamTxt,el.mCamB64M,el.mCamTxtM].forEach(b=>b&&b.classList.remove('sel'));
  ({ENC:el.mEnc,DEC:el.mDec,FILE:el.mFile,B2F:el.mB2F,CAM_B64:el.mCamB64,CAM_TXT:el.mCamTxt,CAM_B64_MULTI:el.mCamB64M,CAM_TXT_MULTI:el.mCamTxtM})[mode]?.classList.add('sel');

  // restore values
  if(el.input)  el.input.value  = tabState[mode].in;
  if(el.output) el.output.value = tabState[mode].out;

  const isText=(mode==='ENC'||mode==='DEC');
  const isFile=(mode==='FILE');
  const isB2F =(mode==='B2F');

  // panels visibility
  el.panelInput.style.display  = (isText||isFile||isB2F)?'block':'none';
  el.panelOutput.style.display = isB2F ? 'none':'block';
  el.qrSend.style.display      = (!isCamMode() && !isB2F) ? 'block':'none';
  el.qrRecv.style.display      = isCamMode() ? 'block':'none';

  // widget visibility
  el.input.style.display       = (isText||isB2F)?'block':'none';
  el.drop.style.display        = isFile ? 'flex':'none';
  // B2F tool row vs Text tools
  el.fileRow.style.display     = isB2F ? 'flex' : 'none';
  el.textRow.style.display     = isText ? 'flex' : 'none';

  // output toolbar
  el.btnQR.style.display       = (!isCamMode() && !isB2F) ? 'inline-flex':'none';

  // cam-only options
  el.autoStopWrap.style.display= isTextCam()? 'flex':'none';
  el.gridOpts.style.display    = isMultiMode()? 'flex':'none';

  // placeholder
  el.output.placeholder = (mode==='DEC'||isTextCam()) ? 'ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™' :
                          (mode==='FILE') ? 'ã“ã“ã«Base64ãŒè¡¨ç¤ºã•ã‚Œã¾ã™' :
                          'ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™';

  // brief
  if (el.brief) el.brief.textContent = briefText[mode] || '';

  // ensure overlay grid drawn
  drawOverlayGrid();
}

/* ===== Base64 utils ===== */
function utf8ToB64(str){
  if (window.TextEncoder){
    const bytes=new TextEncoder().encode(str);
    let bin=''; for(const b of bytes) bin+=String.fromCharCode(b);
    return btoa(bin);
  }
  return btoa(unescape(encodeURIComponent(str)));
}
function normalizeB64(b64){
  let s=(b64||'').trim();
  s=s.replace(/^data:.*;base64,/i,'').replace(/\s+/g,'').replace(/-/g,'+').replace(/_/g,'/');
  s+='='.repeat((4-(s.length%4))%4);
  return s;
}
function b64ToUtf8(b64){
  const clean=normalizeB64(b64);
  if (window.TextDecoder){
    const bin=atob(clean); const bytes=new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
    return new TextDecoder('utf-8').decode(bytes);
  }
  return decodeURIComponent(escape(atob(clean)));
}

/* ===== QR send ===== */
const fmtMMSS = x => { const t=Math.max(0,Math.floor(x)); const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return `${m}:${s}`; };
const checksum = str => { let s=0; for(let i=0;i<str.length;i++) s=(s+str.charCodeAt(i))&0xffff; return s; };
const FRAME_RE=/^\[(\d+)\/(\d+)\|(\d+)\]([\s\S]*)$/;
let qrChunks=[], idx=0, playing=false, timer=null, fpsRate=1.0;

function splitFrames(text, maxPayload){
  const total=Math.ceil(text.length/maxPayload)||1, frames=[];
  for(let i=0;i<total;i++){ const p=text.slice(i*maxPayload,(i+1)*maxPayload); frames.push(`[${i+1}/${total}|${checksum(p)}]${p}`); }
  return frames;
}
function splitFramesNoHeader(text,maxPayload){
  const total=Math.ceil(text.length/maxPayload)||1, frames=[];
  for(let i=0;i<total;i++){ frames.push(text.slice(i*maxPayload,(i+1)*maxPayload)); }
  return frames;
}
function buildSequence(){
  const s=el.output?.value.trim();
  if(!s){ alert('å‡ºåŠ›ãŒç©ºã§ã™'); return false; }
  if(typeof QRCode==='undefined'){ alert('QRCodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'); return false; }
  const maxPayload=700;
  const withHeader = !(el.noHdr && el.noHdr.checked);
  qrChunks = withHeader ? splitFrames(s,maxPayload) : splitFramesNoHeader(s,maxPayload);
  idx=0; el.scrub.max=Math.max(qrChunks.length-1,0); el.scrub.value=0;
  renderQR(); updateTime(); updateInd();
  return true;
}
function renderQR(){ el.qrWrap.innerHTML=''; const text=qrChunks[idx]||''; new QRCode(el.qrWrap,{text,width:320,height:320,correctLevel:QRCode.CorrectLevel.M}); }
function updateTime(){ const total=qrChunks.length; const dur=total/fpsRate; const cur=(idx+1)/fpsRate; el.elapsed.textContent=fmtMMSS(cur); el.duration.textContent=fmtMMSS(dur); }
function updateInd(){ el.frameInd.textContent=`${Math.min(idx+1,qrChunks.length)} / ${qrChunks.length}`; }
function play(){ if(playing||!qrChunks.length) return; playing=true; el.btnPlay.textContent='â¸'; tick(); }
function pause(){ playing=false; el.btnPlay.textContent='â–¶'; if(timer){ clearTimeout(timer); timer=null; } }
function tick(){ if(!playing) return; const interval=Math.max(1,Math.round(1000/fpsRate)); timer=setTimeout(()=>{ if(idx<qrChunks.length-1){ idx++; el.scrub.value=idx; renderQR(); updateTime(); updateInd(); tick(); } else { pause(); } }, interval); }
function prev(){ if(idx>0){ idx--; el.scrub.value=idx; renderQR(); updateTime(); updateInd(); } }
function next(){ if(idx<qrChunks.length-1){ idx++; el.scrub.value=idx; renderQR(); updateTime(); updateInd(); } }

/* ===== Receive (cam) ===== */
const rx = { total:0, got:new Map() };
const rxTxt = { buffer:'' };
function toast(msg,bad=false){
  const d=document.createElement('div');
  d.textContent=msg;
  d.style.cssText=`position:fixed;left:50%;bottom:24px;transform:translateX(-50%);padding:8px 12px;border-radius:8px;color:#fff;background:${bad?'#d32f2f':'#333'};z-index:9999;opacity:.95;`;
  document.body.appendChild(d); setTimeout(()=>d.remove(),1200);
}
function appendHeaderedAndMaybeComplete(frame){
  const m=FRAME_RE.exec(String(frame).trim()); if(!m) return {matched:false};
  const i=parseInt(m[1],10), total=parseInt(m[2],10), sum=parseInt(m[3],10), payload=m[4];
  if (checksum(payload)!==sum) { toast('ãƒã‚§ãƒƒã‚¯ã‚µãƒ ä¸ä¸€è‡´',true); return {matched:true,ok:false}; }
  if (!rx.total) rx.total=total; if (rx.total!==total){ toast('ç·ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“',true); return {matched:true,ok:false}; }
  const already = rx.got.has(i) && rx.got.get(i)===payload;
  rx.got.set(i,payload);
  if (el.rxStatus) el.rxStatus.textContent=`${rx.got.size}/${rx.total}`;
  if (already) return {matched:true,ok:true,complete:false};
  if (rx.got.size===rx.total){
    const parts=[]; for(let k=1;k<=rx.total;k++){ const p=rx.got.get(k); if(typeof p!=='string'){ toast(`æ¬ è½: ${k}`,true); return {matched:true,ok:false}; } parts.push(p); }
    const joined=parts.join(''); rx.total=0; rx.got.clear(); if(el.rxStatus) el.rxStatus.textContent='0/0';
    return {matched:true,ok:true,complete:true,payload:joined};
  }
  return {matched:true,ok:true,complete:false};
}
function ingestB64(text){
  const r=appendHeaderedAndMaybeComplete(text);
  if(!r.matched){ el.output.value += text; }
  else if(r.complete){ el.output.value = r.payload; }
}
function ingestText(text){
  const r=appendHeaderedAndMaybeComplete(text);
  if(!r.matched){ rxTxt.buffer += text; try{ el.output.value = b64ToUtf8(rxTxt.buffer); }catch{} }
  else if(r.complete){ try{ el.output.value = b64ToUtf8(r.payload); }catch{ toast('ãƒ†ã‚­ã‚¹ãƒˆã«å¾©å·ã§ãã¾ã›ã‚“ã§ã—ãŸ',true); } }
}

/* Camera scan */
let camStream=null, rafId=null;
const STABLE_FRAMES=2, DEDUPE_TTL_MS=8000;
const camD={curr:'',same:0};           // single
const slotState=new Map();              // multi
const seenHashes=new Map();            // TTL
const fp32=(s)=>{ let h=0x811c9dc5|0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h+= (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24); } return h>>>0; };

async function startScan(){
  if(typeof jsQR==='undefined'){ alert('jsQRãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
  if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){ alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©æœªå¯¾å¿œã§ã™'); return; }
  try{
    camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}},audio:false});
    el.cam.srcObject=camStream;
    await el.cam.play();
    ensureOverlaySize(); drawOverlayGrid(); tickCam();
  }catch(e){ alert('ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—: '+e.message); }
}
function stopScan(){ if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; } if(rafId){ cancelAnimationFrame(rafId); rafId=null; } }
function ensureOverlaySize(){
  const vw=el.cam.videoWidth||1280, vh=el.cam.videoHeight||720;
  const c=el.camOv; c.width=vw; c.height=vh;
  c.style.width=el.cam.clientWidth+'px';
  c.style.height=el.cam.clientHeight+'px';
}
function drawOverlayGrid(){
  const ctx=el.camOv.getContext('2d');
  ctx.clearRect(0,0,el.camOv.width,el.camOv.height);
  if (!isMultiMode()) return;
  const rows=Math.max(1,Math.min(6,parseInt(el.rows.value,10)||2));
  const cols=Math.max(1,Math.min(6,parseInt(el.cols.value,10)||2));
  const w=el.camOv.width, h=el.camOv.height;
  ctx.strokeStyle='rgba(37,99,235,.9)'; ctx.lineWidth=2;
  for(let r=1;r<rows;r++){ const y=Math.round(h*r/rows)+.5; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
  for(let c=1;c<cols;c++){ const x=Math.round(w*c/cols)+.5; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
}
function drawDetections(dets){
  const ctx=el.camOv.getContext('2d');
  drawOverlayGrid();
  for(const d of dets){
    const pts=d.corners;
    ctx.save();
    ctx.lineWidth=4; ctx.strokeStyle='rgba(16,185,129,.95)'; ctx.shadowColor='rgba(0,0,0,.45)'; ctx.shadowBlur=4;
    ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y); for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x,pts[i].y); ctx.closePath(); ctx.stroke();
    ctx.fillStyle='rgba(16,185,129,.95)';
    for(const p of pts){ ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill(); }
    ctx.restore();
  }
}
function getSlots(){
  const vw=el.cam.videoWidth, vh=el.cam.videoHeight; if(!vw||!vh) return [];
  if(!isMultiMode()){
    const m=Math.max(0,parseInt(el.roiMargin.value,10)||0);
    return [{x:m,y:m,w:vw-2*m,h:vh-2*m}];
  }
  const rows=Math.max(1,Math.min(6,parseInt(el.rows.value,10)||2));
  const cols=Math.max(1,Math.min(6,parseInt(el.cols.value,10)||2));
  const m=Math.max(0,parseInt(el.roiMargin.value,10)||0);
  const slots=[]; const cellW=Math.floor(vw/cols), cellH=Math.floor(vh/rows);
  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
    const x=c*cellW+m, y=r*cellH+m;
    const w=(c===cols-1? vw-c*cellW:cellW)-2*m;
    const h=(r===rows-1? vh-r*cellH:cellH)-2*m;
    if(w>20&&h>20) slots.push({x,y,w,h});
  }
  return slots;
}
function tickCam(){
  if(!camStream) return;
  const v=el.cam, c=el.camCanvas, ctx=c.getContext('2d');
  const w=v.videoWidth, h=v.videoHeight; if(!w||!h){ rafId=requestAnimationFrame(tickCam); return; }
  c.width=w; c.height=h;
  const slots=getSlots(); if(!slots.length){ rafId=requestAnimationFrame(tickCam); return; }
  const dets=[];
  if(!isMultiMode()){
    ctx.drawImage(v,0,0,w,h);
    const img=ctx.getImageData(0,0,w,h);
    const code=jsQR(img.data,img.width,img.height,{inversionAttempts:'dontInvert'});
    if(code && code.location){
      const L=code.location;
      dets.push({corners:[L.topLeftCorner,L.topRightCorner,L.bottomRightCorner,L.bottomLeftCorner]});
    }
    handleQr(code && code.data, null);
  }else{
    for(let i=0;i<slots.length;i++){
      const s=slots[i];
      ctx.drawImage(v,s.x,s.y,s.w,s.h,0,0,s.w,s.h);
      const img=ctx.getImageData(0,0,s.w,s.h);
      const code=jsQR(img.data,img.width,img.height,{inversionAttempts:'dontInvert'});
      if(code && code.location){
        const L=code.location, tg=p=>({x:p.x+s.x, y:p.y+s.y});
        dets.push({corners:[tg(L.topLeftCorner),tg(L.topRightCorner),tg(L.bottomRightCorner),tg(L.bottomLeftCorner)]});
      }
      handleQr(code && code.data, i);
    }
  }
  drawDetections(dets);
  rafId=requestAnimationFrame(tickCam);
}
function handleQr(str, slot){
  const reset=(obj)=>{ obj.curr=''; obj.same=0; };
  if(!str){ if(slot!=null){ const st=slotState.get(slot)||{curr:'',same:0}; reset(st); slotState.set(slot,st); } else reset(camD); return; }
  const m=FRAME_RE.exec(str);
  if(m){
    const i=parseInt(m[1],10), payload=m[4];
    const dup= rx.got.has(i)&&rx.got.get(i)===payload;
    if(!dup){ isTextCam()? ingestText(str) : ingestB64(str); }
    if(slot!=null){ const st=slotState.get(slot)||{curr:'',same:0}; reset(st); slotState.set(slot,st); } else reset(camD);
    return;
  }
  // headerless: stability + TTL dedupe
  const nowProc=(obj)=>{
    if(str===obj.curr) obj.same++; else { obj.curr=str; obj.same=1; }
    if(obj.same>=STABLE_FRAMES){
      const h=fp32(str), now=Date.now(), last=seenHashes.get(h)||0;
      if(now-last>DEDUPE_TTL_MS){
        if(isTextCam()){ ingestText(str); if(el.autoStopHL && el.autoStopHL.checked) stopScan(); }
        else ingestB64(str);
        seenHashes.set(h,now); obj.same=0;
      }
    }
  };
  if(slot!=null){ const st=slotState.get(slot)||{curr:'',same:0}; nowProc(st); slotState.set(slot,st); }
  else nowProc(camD);
}

/* ===== Convert / IO ===== */
function convert(){
  const s=el.input?.value.trim();
  if(!s){ alert('å…¥åŠ›ãŒç©ºã§ã™'); return; }
  try{
    if(mode==='ENC') el.output.value = utf8ToB64(s);
    else if(mode==='DEC') el.output.value = b64ToUtf8(s);
  }catch(e){
    alert('å¤‰æ›ã«å¤±æ•—: '+e.message+'\n\nâ€»Base64ã¯æ”¹è¡Œ/URL-safeå¯ã€data:ãƒ˜ãƒƒãƒ€ã¯è‡ªå‹•é™¤å»');
  }
}
function convertAndShowQR(){
  if(mode==='ENC'){
    convert();
    if(buildSequence()) window.scrollTo({top:el.qrSend.offsetTop-10,behavior:'smooth'});
  }else if(mode==='FILE'){
    // FILEâ†’B64 ã¯ drop/é¸æŠå®Œäº†ã§ output ã«å…¥ã‚‹ã®ã§ã€ã“ã“ã§ã¯è¡¨ç¤ºã ã‘
    if(!el.output.value.trim()){ alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶ã‹ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„'); return; }
    if(buildSequence()) window.scrollTo({top:el.qrSend.offsetTop-10,behavior:'smooth'});
  }
}
async function copyOut(){
  const s=el.output?.value; if(!s) return;
  try{ await navigator.clipboard.writeText(s); toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }
  catch(_){ const ta=el.output; if(!ta) return; ta.focus(); ta.select(); document.execCommand && document.execCommand('copy'); toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); window.getSelection().removeAllRanges(); }
}
async function pasteIntoInput(){
  try{
    const t=await navigator.clipboard.readText();
    if(!t){ toast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒç©ºã§ã™',true); return; }
    el.input.value=t; toast('è²¼ã‚Šä»˜ã‘ã¾ã—ãŸ');
  }catch{ toast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰èª­ã¿å–ã‚ŠãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“',true); }
}
function clearInput(){ el.input.value=''; el.input.focus(); }
function handleFiles(files){
  if(!files||!files.length) return;
  const f=files[0], r=new FileReader();
  r.onload=e=>{ const b64=(String(e.target.result).split(',')[1]||''); el.output.value=b64; toast(f.name+' ã‚’Base64åŒ–ã—ã¾ã—ãŸ'); };
  r.readAsDataURL(f);
}
function saveFile(){
  const b64=el.input?.value.trim(); if(!b64){ alert('Base64ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const name=(el.filename?.value.trim()||'download'); const ext=el.filetype?.value||'bin';
  const mime=({pdf:'application/pdf',docx:'application/vnd.openxmlformats-officedocument.wordprocessingml.document',xlsx:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',pptx:'application/vnd.openxmlformats-officedocument.presentationml.presentation',png:'image/png',jpg:'image/jpeg',mp4:'video/mp4',exe:'application/vnd.microsoft.portable-executable',bin:'application/octet-stream'})[ext]||'application/octet-stream';
  try{
    const clean=normalizeB64(b64), bin=atob(clean); const arr=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
    const blob=new Blob([arr],{type:mime}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`${name}.${ext}`; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),1500);
  }catch(e){ alert('ä¿å­˜ã«å¤±æ•—: '+e.message); }
}

/* ===== Events ===== */
on($('btn-goto-help'),'click',()=>document.getElementById('help').scrollIntoView({behavior:'smooth'}));

on(el.mEnc,'click',()=>setMode('ENC'));
on(el.mDec,'click',()=>setMode('DEC'));
on(el.mFile,'click',()=>setMode('FILE'));
on(el.mB2F,'click',()=>setMode('B2F'));
on(el.mCamB64,'click',()=>setMode('CAM_B64'));
on(el.mCamTxt,'click',()=>setMode('CAM_TXT'));
on(el.mCamB64M,'click',()=>setMode('CAM_B64_MULTI'));
on(el.mCamTxtM,'click',()=>setMode('CAM_TXT_MULTI'));

on(el.btnConvert,'click',convert);
on(el.btnConvertQR,'click',convertAndShowQR);
on(el.input,'keydown',e=>{
  if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); if(mode==='ENC'||mode==='DEC') convert(); }
  if(e.shiftKey && e.key==='Enter'){ e.preventDefault(); if(mode==='ENC'||mode==='FILE') convertAndShowQR(); }
});
on(el.btnCopy,'click',copyOut);
on(el.btnQR,'click',()=>{ if(buildSequence()) renderQR(); });
on(el.btnPrev,'click',prev);
on(el.btnNext,'click',next);
on(el.btnPlay,'click',()=> playing?pause():play());
on(el.scrub,'input',()=>{ idx=parseInt(el.scrub.value||'0',10)||0; renderQR(); updateTime(); updateInd(); });

on(el.btnPaste,'click',pasteIntoInput);
on(el.btnClear,'click',clearInput);
on(el.btnPasteText,'click',pasteIntoInput);
on(el.btnClearText,'click',clearInput);

on(el.fileBtn,'click',()=>el.fileInput?.click());
on(el.fileInput,'change',()=>handleFiles(el.fileInput?.files));
on(el.drop,'dragover',e=>{ e.preventDefault(); el.drop.classList.add('hover'); });
on(el.drop,'dragleave',()=>el.drop.classList.remove('hover'));
on(el.drop,'drop',e=>{ e.preventDefault(); el.drop.classList.remove('hover'); handleFiles(e.dataTransfer?.files); });

on(el.btnSave,'click',saveFile);

on(el.btnScanStart,'click',startScan);
on(el.btnScanStop,'click',stopScan);
['change','input'].forEach(ev=>{
  on(el.rows,ev,drawOverlayGrid);
  on(el.cols,ev,drawOverlayGrid);
  on(el.roiMargin,ev,drawOverlayGrid);
});
on(el.cam,'loadedmetadata',()=>{ ensureOverlaySize(); drawOverlayGrid(); });
on(window,'resize',()=>{ ensureOverlaySize(); drawOverlayGrid(); });

/* Ripple */
document.addEventListener('click',(e)=>{
  const b=e.target.closest('button.ripple'); if(!b) return;
  const rect=b.getBoundingClientRect();
  const x=((e.clientX-rect.left)/rect.width)*100, y=((e.clientY-rect.top)/rect.height)*100;
  b.style.setProperty('--ripple-x',x+'%'); b.style.setProperty('--ripple-y',y+'%');
  b.classList.remove('rippling'); void b.offsetWidth; b.classList.add('rippling');
  setTimeout(()=>b.classList.remove('rippling'),600);
});

/* Help footer QR */
(function(){
  const box=$('help-qr');
  if(box && typeof QRCode!=='undefined'){
    new QRCode(box,{text:'suzuki.yuya.kitasato@gmail.com',width:110,height:110,correctLevel:QRCode.CorrectLevel.M});
  }
})();

/* init */
setMode('ENC');
updateTime(); updateInd();
});
</script>
</body>
</html>
