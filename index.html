<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>テキストQRコード変換</title>

<!-- Favicon / iOS -->
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="/apple-touch-icon-180.png" sizes="180x180">
<meta name="theme-color" content="#0d47a1">

<!-- Material Symbols -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet"
  href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300..700&display=swap" />

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js" defer></script>

<style>
:root{
  --pri:#0d47a1;   /* Primary */
  --pri-2:#039be5; /* Accent */
  --err:#d32f2f;   /* Error */
  --surf:#eceff1;  /* Surface */
  --chip:#81d4fa;  /* Selected-chip */
  --fg:#1f2937;    /* Text */
  --muted:#6b7280; /* Sub text */
  --br:#dde1e6;    /* Border */
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI",Meiryo,"Yu Gothic",sans-serif;
  color:var(--fg);
  background:#fff;
  display:flex;flex-direction:column;
}

/* Header */
header{background:var(--pri);color:#fff}
.header-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 16px;gap:12px;
}
.title{display:flex;align-items:center;gap:10px;font-weight:700}
.title img{width:22px;height:22px}
.header-actions{display:flex;align-items:center;gap:8px}
.badge{display:inline-block;background:#13409e;color:#fff;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid #2a56c6}

.container{padding:12px;display:flex;flex-direction:column;gap:12px}

/* --- Segment buttons (丸ボタン) --- */
.mode{display:flex;gap:8px;flex-wrap:wrap}
.seg{
  display:grid;
  grid-template-columns:repeat(4, minmax(0,1fr));
  gap:8px;width:100%;
  border:1px solid var(--br);background:#fff;border-radius:14px;padding:8px;
}
.seg button{
  display:flex;align-items:center;justify-content:center;gap:8px;
  width:100%;
  border:1px solid var(--br);background:#fff;color:var(--fg);
  border-radius:999px;padding:10px 12px;cursor:pointer;
  transition:background .15s ease, box-shadow .15s ease, transform .05s ease;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.seg button:hover{background:#f6f9ff}
.seg button.sel{background:var(--chip); border-color:#bde7ff}
.seg .label{display:inline}      /* PC: 日本語ラベルのみ */
.seg .icons{display:none}         /* PC: アイコン非表示 */

/* Mobile = アイコンのみ */
@media (max-width: 760px){
  .seg{grid-template-columns:repeat(4, minmax(0,1fr))}
  .seg .label{display:none}
  .seg .icons{display:flex}
}

/* Material icon helper */
.ms{font-family:"Material Symbols Outlined", sans-serif;font-weight:400;font-style:normal;
  font-size:20px;line-height:1;display:inline-flex;align-items:center;justify-content:center}

/* 同サイズ2枚重ね（小さめ） */
.icon-twins{position:relative;width:22px;height:22px}
.icon-twins .ms{position:absolute;font-size:16px}
.icon-twins .ms.a{left:2px;top:2px}
.icon-twins .ms.b{right:2px;bottom:2px}

/* B64 image icon (mobile 丸ボタン用) */
.b64-img{width:18px;height:18px;object-fit:contain;display:inline-block}

/* Panels */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width: 900px){ .grid{grid-template-columns:1fr} }
.panel{border:1px solid var(--br);border-radius:10px;padding:12px;background:#fff;display:flex;flex-direction:column;gap:10px}
.panel h2{margin:0;font-size:15px}
textarea{width:100%;min-height:240px;resize:vertical;font-size:15px;line-height:1.5;padding:10px;border:1px solid #cfd4da;border-radius:8px}
textarea.autosize{overflow:hidden} /* 自動リサイズ用 */
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.row.split{justify-content:space-between;gap:12px}
.row.right{justify-content:flex-end}

/* Buttons */
button,select,input[type="text"],input[type="file"],input[type="number"]{
  font-size:14.5px;padding:9px 12px;border:1px solid #cfd4da;border-radius:8px;background:#fff
}
button{cursor:pointer}
.btn-primary{background:var(--pri);color:#fff;border:none}
.btn-secondary{background:var(--pri-2);color:#fff;border:none}
.btn-danger{background:var(--err);color:#fff;border:none}
.btn-surface{background:var(--surf)}
button:hover:not(:disabled){filter:brightness(0.98)}
button:active:not(:disabled){transform:translateY(1px)}
button:disabled{opacity:.6;cursor:default}
.btn-icon{padding:8px;width:40px;height:40px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center}

/* 小さなショートカット表示 */
.kbd{background:#f3f5f8;border:1px solid #dfe3e8;border-bottom-width:2px;border-radius:4px;padding:1px 6px;font-family:ui-monospace,Menlo,Consolas,monospace}
.kbd.small{font-size:12px}
.hint-wrap{display:flex;align-items:center;gap:6px}

/* Tooltip */
[data-tip]{position:relative}
[data-tip]::after{
  content:attr(data-tip);
  position:absolute;left:50%;transform:translate(-50%,-6px);bottom:100%;
  background:#111;color:#fff;font-size:12px;padding:6px 8px;border-radius:6px;
  white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .12s ease;
  box-shadow:0 4px 12px rgba(0,0,0,.18)
}
[data-tip]::before{
  content:""; position:absolute; left:50%; bottom:100%; transform:translate(-50%,6px);
  border:6px solid transparent; border-top-color:#111; opacity:0; transition:opacity .12s ease;
}
[data-tip]:hover::after,[data-tip]:hover::before{opacity:1}

/* QR sender */
.qr-wrap{display:flex;align-items:center;justify-content:center;height:320px;background:#fff;border:1px solid #eee;border-radius:10px}
.qr-scrub{display:flex;align-items:center;gap:8px}
.time{min-width:56px;text-align:right;font-variant-numeric:tabular-nums}
.range{flex:1}
.qr-bottom{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
.fps-wrap{display:flex;align-items:center;gap:8px}
.fps-wrap input[type="number"]{width:84px;text-align:right}

/* Camera receive */
.video-box{position:relative}
video#cam{width:100%;max-height:340px;background:#000;border-radius:10px;display:block}
canvas.overlay{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;border-radius:10px}
.rx-note{color:var(--muted);font-size:13px}

/* Help modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:10000}
.modal.show{display:flex}
.modal .box{width:min(900px,92vw);max-height:86vh;overflow:auto;background:#fff;border-radius:14px;padding:16px;box-shadow:0 18px 36px rgba(0,0,0,.25)}
.modal .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--br)}
.modal h3{margin:8px 0 6px}
.modal ul{margin:6px 0 6px 1.2em;padding:0}

@media (prefers-reduced-motion: reduce){ *{transition:none !important;animation:none !important} }
</style>
</head>

<body>
<header>
  <div class="header-row">
    <div class="title">
      <img src="/favicon.svg" alt="">
      <span>テキストQRコード変換</span>
    </div>
    <div class="header-actions">
      <span id="ver" class="badge" title="バージョン">ver 1.7</span>
      <div class="hint-wrap">
        <button id="btn-help" class="btn-secondary" data-tip="ヘルプ（?）">ヘルプ</button>
        <span class="kbd small">?</span>
      </div>
    </div>
  </div>
</header>

<div class="container">

  <!-- 丸ボタン（PC: 日本語ラベル／スマホ: アイコンのみ） -->
  <div class="mode">
    <div class="seg" role="tablist" aria-label="mode">
      <button id="m-enc" class="sel" role="tab" aria-label="テキストからBase64へ">
        <span class="label">テキスト → Base64</span>
        <span class="icons" aria-hidden="true">
          <span class="ms">text_ad</span><span class="ms">arrow_forward</span>
          <img src="./B64.png" class="b64-img" alt="B64">
        </span>
      </button>
      <button id="m-dec" role="tab" aria-label="Base64からテキストへ">
        <span class="label">Base64 → テキスト</span>
        <span class="icons" aria-hidden="true">
          <img src="./B64.png" class="b64-img" alt="B64"><span class="ms">arrow_forward</span><span class="ms">text_ad</span>
        </span>
      </button>
      <button id="m-file" role="tab" aria-label="ファイルからBase64へ">
        <span class="label">ファイル → Base64</span>
        <span class="icons" aria-hidden="true">
          <span class="ms">folder</span><span class="ms">arrow_forward</span>
          <img src="./B64.png" class="b64-img" alt="B64">
        </span>
      </button>
      <button id="m-b2f" role="tab" aria-label="Base64からファイルへ">
        <span class="label">Base64 → ファイル</span>
        <span class="icons" aria-hidden="true">
          <img src="./B64.png" class="b64-img" alt="B64"><span class="ms">arrow_forward</span><span class="ms">folder</span>
        </span>
      </button>
      <button id="m-cam" role="tab" aria-label="QRからBase64へ">
        <span class="label">QR → Base64</span>
        <span class="icons" aria-hidden="true">
          <span class="ms">qr_code_2</span><span class="ms">arrow_forward</span>
          <img src="./B64.png" class="b64-img" alt="B64">
        </span>
      </button>
      <button id="m-camtxt" role="tab" aria-label="QRからテキストへ">
        <span class="label">QR → テキスト</span>
        <span class="icons" aria-hidden="true">
          <span class="ms">qr_code_2</span><span class="ms">arrow_forward</span><span class="ms">text_ad</span>
        </span>
      </button>
      <button id="m-cam-multi" role="tab" aria-label="複数QRからBase64へ">
        <span class="label">QR複数 → Base64</span>
        <span class="icons" aria-hidden="true">
          <span class="icon-twins"><span class="ms a">qr_code_2</span><span class="ms b">qr_code_2</span></span>
          <span class="ms">arrow_forward</span><img src="./B64.png" class="b64-img" alt="B64">
        </span>
      </button>
      <button id="m-camtxt-multi" role="tab" aria-label="複数QRからテキストへ">
        <span class="label">QR複数 → テキスト</span>
        <span class="icons" aria-hidden="true">
          <span class="icon-twins"><span class="ms a">qr_code_2</span><span class="ms b">qr_code_2</span></span>
          <span class="ms">arrow_forward</span><span class="ms">text_ad</span>
        </span>
      </button>
    </div>
  </div>

  <!-- 簡易説明 -->
  <div id="mode-desc" class="panel" style="padding:10px 12px">
    <div id="desc-text" style="font-size:13.5px;color:#374151"></div>
  </div>

  <!-- 入出力（通常時：入力＋出力 / QR時：QR入力＋出力） -->
  <div class="grid" id="text-io">
    <!-- 入力 or 非表示（QR時） -->
    <section class="panel" id="panel-input">
      <h2>入力</h2>
      <textarea id="input" class="autosize" placeholder="ここにテキストまたはBase64を入力…"></textarea>

      <!-- ファイル→B64 のときだけ -->
      <div id="drop-zone" class="panel" style="border-style:dashed;display:none;padding:16px">
        <div style="display:flex;align-items:center;justify-content:center;width:100%;height:160px">
          <div class="row" style="gap:10px;align-items:center">
            <span class="ms">folder_open</span>
            <span>ファイルをドラッグ＆ドロップ</span>
            <button id="btn-file-choose" class="btn-surface" data-tip="ファイル選択">
              <span class="ms">upload_file</span>
            </button>
          </div>
        </div>
        <input id="file-input" type="file" style="display:none"/>
      </div>

      <!-- B64→ファイル 用 -->
      <div id="b2f-rows" class="row split" style="display:none">
        <div class="row">
          <button id="btn-paste" class="btn-icon btn-surface" data-tip="クリップボードをペースト">
            <span class="ms">content_paste</span>
          </button>
          <button id="btn-clear" class="btn-icon btn-danger" data-tip="クリア">
            <span class="ms">delete</span>
          </button>
        </div>
        <div class="row">
          <label>形式
            <select id="filetype">
              <option value="pdf">PDF</option>
              <option value="docx">Word (.docx)</option>
              <option value="xlsx">Excel (.xlsx)</option>
              <option value="pptx">PowerPoint (.pptx)</option>
              <option value="png">PNG</option>
              <option value="jpg">JPEG</option>
              <option value="mp4">MP4</option>
              <option value="exe">EXE</option>
              <option value="bin">バイナリ (.bin)</option>
            </select>
          </label>
          <input id="filename" type="text" placeholder="保存時のファイル名（拡張子なし）"/>
          <button id="btn-save" class="btn-primary" data-tip="名前を付けて保存">
            <span class="ms">save_as</span>
          </button>
        </div>
      </div>

      <!-- テキスト↔B64 の操作 -->
      <div id="text-actions" class="row right">
        <div class="hint-wrap">
          <button id="btn-conv-qr" class="btn-primary btn-icon" data-tip="変換＋QRを表示（Shift+Enter）">
            <span class="ms">qr_code_2</span>
          </button>
          <span class="kbd small">Shift+Enter</span>
        </div>
        <div class="hint-wrap">
          <button id="btn-convert" class="btn-secondary btn-icon" data-tip="変換（Ctrl/⌘+Enter）">
            <span class="ms">convert_to_text</span>
          </button>
          <span class="kbd small">Ctrl/⌘+Enter</span>
        </div>
        <button id="btn-clear-plain" class="btn-icon btn-danger" data-tip="クリア">
          <span class="ms">delete</span>
        </button>
        <button id="btn-paste-plain" class="btn-icon btn-surface" data-tip="クリップボードをペースト">
          <span class="ms">content_paste</span>
        </button>
      </div>
    </section>

    <!-- 出力（QR時も右 / モバイルは下） -->
    <section class="panel" id="panel-output">
      <h2>出力</h2>
      <textarea id="output" placeholder="ここに結果が表示されます"></textarea>
      <div class="row right">
        <button id="btn-copy" class="btn-icon btn-surface" data-tip="コピー">
          <span class="ms">content_copy</span>
        </button>
        <button id="btn-share" class="btn-icon btn-secondary" data-tip="共有（他のアプリへ）">
          <span class="ms">ios_share</span>
        </button>
        <button id="btn-qrshow" class="btn-secondary" data-tip="QR表示（連続）">QR表示（連続）</button>
      </div>
    </section>
  </div>

  <!-- QR 送出 -->
  <section class="panel" id="qr-send">
    <h2>QRシーケンス出力</h2>
    <div class="qr-wrap" id="qr-display"></div>
    <div class="qr-scrub">
      <span id="elapsed" class="time">00:00</span>
      <input id="scrub" class="range" type="range" min="0" max="0" step="1" value="0"/>
      <span id="duration" class="time">00:00</span>
      <span id="frame-ind" style="color:var(--muted)">0 / 0</span>
    </div>
    <div class="qr-bottom">
      <button id="btn-prev" class="btn-surface" data-tip="前のフレーム"><span class="ms">fast_rewind</span></button>
      <button id="btn-play" class="btn-secondary" data-tip="再生 / 一時停止"><span class="ms">play_arrow</span></button>
      <button id="btn-next" class="btn-surface" data-tip="次のフレーム"><span class="ms">fast_forward</span></button>
      <div class="fps-wrap">
        <label>速度(FPS)
          <input id="fps" type="range" min="0.5" max="120" step="0.1" value="2.0"/>
        </label>
        <input id="fps-num" type="number" min="0.5" max="120" step="0.1" value="2.0"/>
      </div>
      <label style="display:flex;align-items:center;gap:6px">
        <input id="no-header" type="checkbox" checked> ヘッダなし（電子カルテ向け）
      </label>
    </div>
  </section>

  <!-- QR 入力（カメラ） -->
  <section class="panel" id="qr-recv" style="display:none;">
    <h2>QR入力</h2>
    <div class="row" style="gap:10px">
      <button id="btn-scan-start" class="btn-primary btn-icon" data-tip="カメラ開始">
        <span class="ms">qr_code_scanner</span>
      </button>
      <button id="btn-scan-stop" class="btn-danger btn-icon" data-tip="停止">
        <span class="ms">stop</span>
      </button>

      <!-- オプションは控えめに -->
      <details id="opt-details" style="margin-left:auto">
        <summary>オプション</summary>
        <div class="row" style="margin-top:6px">
          <label style="display:flex;align-items:center;gap:6px">
            <input id="auto-stop-hl" type="checkbox">
            ヘッダなしは1枚読んだら自動停止（QR→テキスト）
          </label>
        </div>
        <div class="row" id="grid-opts">
          <label>行: <input id="rows" type="number" min="1" max="6" value="2"></label>
          <label>列: <input id="cols" type="number" min="1" max="6" value="2"></label>
          <label>ROI余白(px): <input id="roi-margin" type="number" min="0" max="80" value="16"></label>
        </div>
      </details>
    </div>

    <div class="video-box">
      <video id="cam" playsinline muted></video>
      <canvas id="cam-overlay" class="overlay"></canvas>
    </div>
    <canvas id="cam-canvas" style="display:none"></canvas>

    <div class="rx-note">受信進捗（ヘッダ付き時）: <span id="rx-status">0/0</span></div>
  </section>

</div><!-- /.container -->

<!-- Help Modal -->
<div id="help-modal" class="modal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true" aria-labelledby="help-title">
    <div class="topbar">
      <h2 id="help-title">ヘルプ</h2>
      <div class="row">
        <a href="https://www.notion.so/y847/QR-228ef3115d7480528fe0f82920945df3" target="_blank" class="btn-surface" style="text-decoration:none;padding:8px 10px">Notion（使い方）</a>
        <button id="btn-help-close" class="btn-surface">閉じる</button>
      </div>
    </div>

    <div class="content" style="font-size:14.5px">
      <h3>モードの説明</h3>
      <ul>
        <li><b>テキスト → Base64</b>：文章を Base64 に変換します。QR にもできます。</li>
        <li><b>Base64 → テキスト</b>：Base64 をテキストへ復号します。</li>
        <li><b>ファイル → Base64</b>：あらゆるファイルを Base64 にします（画像 / PDF / Office など）。</li>
        <li><b>Base64 → ファイル</b>：Base64 からファイルへ復元します（mp4 対応）。</li>
        <li><b>QR → Base64</b>：カメラで QR を読み取り、Base64 として受信します。</li>
        <li><b>QR → テキスト</b>：カメラで QR を読み取り、テキストとして受信します。</li>
        <li><b>QR複数 → Base64</b>：映像をグリッド分割して複数 QR を同時に Base64 として受信します。</li>
        <li><b>QR複数 → テキスト</b>：映像をグリッド分割して複数 QR を同時に テキストとして受信します。</li>
      </ul>

      <h3>バージョン</h3>
      <div id="about-version" style="color:var(--muted)">ver 1.7</div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
'use strict';

/* ====== Version / description ====== */
const APP_VERSION = 'ver 1.7';
const APP_BUILD   = '2025-08-10';
document.getElementById('ver').textContent = APP_VERSION;

/* ====== Helpers ====== */
const $ = id => document.getElementById(id);
const on = (node, ev, fn) => node && node.addEventListener(ev, fn, false);
const fmtMMSS = x => { const t=Math.max(0,Math.floor(x)); const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return `${m}:${s}`; };

/* ====== Elements ====== */
const el = {
  // tabs
  mEnc: $('m-enc'), mDec: $('m-dec'), mFile: $('m-file'), mB2F: $('m-b2f'),
  mCamB64: $('m-cam'), mCamTxt: $('m-camtxt'), mCamB64M: $('m-cam-multi'), mCamTxtM: $('m-camtxt-multi'),
  // panels
  textIO: $('text-io'), panelInput: $('panel-input'), panelOutput: $('panel-output'),
  // widgets
  input: $('input'), output: $('output'),
  drop: $('drop-zone'), fileBtn: $('btn-file-choose'), fileInput: $('file-input'),
  filename: $('filename'), filetype: $('filetype'),
  btnPaste: $('btn-paste'), btnClear: $('btn-clear'),
  btnPastePlain: $('btn-paste-plain'), btnClearPlain: $('btn-clear-plain'),
  btnCopy: $('btn-copy'), btnShare: $('btn-share'), btnQR: $('btn-qrshow'), btnSave: $('btn-save'),
  btnConvQR: $('btn-conv-qr'), btnConv: $('btn-convert'),
  textActions: $('text-actions'), b2fRows: $('b2f-rows'),
  // send
  qrSend: $('qr-send'), qrWrap: $('qr-display'), scrub: $('scrub'),
  elapsed: $('elapsed'), duration: $('duration'), frameInd: $('frame-ind'),
  btnPrev: $('btn-prev'), btnNext: $('btn-next'), btnPlay: $('btn-play'),
  fps: $('fps'), fpsNum: $('fps-num'), noHdr: $('no-header'),
  // recv
  qrRecv: $('qr-recv'), cam: $('cam'), camCanvas: $('cam-canvas'), camOverlay: $('cam-overlay'),
  btnScanStart: $('btn-scan-start'), btnScanStop: $('btn-scan-stop'),
  rxStatus: $('rx-status'), autoStopHL: $('auto-stop-hl'),
  rows: $('rows'), cols: $('cols'), roiMargin: $('roi-margin'),
  // misc
  modeDesc: $('mode-desc'), descText: $('desc-text'),
  help: { modal: $('help-modal'), btnOpen: $('btn-help'), btnClose: $('btn-help-close'), about: $('about-version') }
};
el.help.about.textContent = `${APP_VERSION}（ビルド: ${APP_BUILD}）`;

/* ====== Mode & descriptions ====== */
let mode = 'ENC';
const tabState = Object.fromEntries(['ENC','DEC','FILE','B2F','CAM_B64','CAM_TXT','CAM_B64_MULTI','CAM_TXT_MULTI']
  .map(k=>[k,{in:'',out:''}]));

const DESC = {
  ENC:  '文章を Base64 に変換します。QR にもできます。',
  DEC:  'Base64 をテキストへ復号します。',
  FILE: 'ファイルを Base64 にします（画像/PDF/Office 等）。',
  B2F:  'Base64 からファイルへ復元します（mp4 対応）。',
  CAM_B64: 'カメラで QR を読み取り Base64 として受信します。',
  CAM_TXT: 'カメラで QR を読み取り テキストとして受信します。',
  CAM_B64_MULTI: 'グリッド分割で複数 QR を同時に Base64 受信します。',
  CAM_TXT_MULTI: 'グリッド分割で複数 QR を同時に テキスト受信します。'
};
function setDesc(key){ el.descText.textContent = DESC[key] || ''; }

const isCamMode = () => /^CAM_/.test(mode);
const isMultiMode = () => (mode==='CAM_B64_MULTI' || mode==='CAM_TXT_MULTI');
const isTextCamMode = () => (mode==='CAM_TXT' || mode==='CAM_TXT_MULTI');

/* 入力テキストエリアの自動リサイズ */
function autosize(ta, min=160){
  if (!ta) return;
  ta.style.height = 'auto';
  const h = Math.max(min, ta.scrollHeight);
  ta.style.height = h + 'px';
}

/* カメラモード時の並びを：QR入力 → 出力 に強制 */
function placeCamPanels(){
  const c = el.textIO;
  if (!isCamMode()) return;
  if (el.qrRecv.parentElement !== c) c.appendChild(el.qrRecv);
  c.insertAdjacentElement('afterbegin', el.qrRecv);   // 先頭へ（左/上）
  if (el.panelOutput.parentElement !== c) c.appendChild(el.panelOutput);
  // 出力は最後にしておく（右/下）
}

function setMode(to){
  tabState[mode].in  = el.input?.value ?? '';
  tabState[mode].out = el.output?.value ?? '';
  mode = to;

  [el.mEnc,el.mDec,el.mFile,el.mB2F,el.mCamB64,el.mCamTxt,el.mCamB64M,el.mCamTxtM].forEach(b=>b&&b.classList.remove('sel'));
  ({ENC:el.mEnc,DEC:el.mDec,FILE:el.mFile,B2F:el.mB2F,CAM_B64:el.mCamB64,CAM_TXT:el.mCamTxt,CAM_B64_MULTI:el.mCamB64M,CAM_TXT_MULTI:el.mCamTxtM})[mode]?.classList.add('sel');

  if (el.input)  el.input.value  = tabState[mode].in;
  if (el.output) el.output.value = tabState[mode].out;

  const isText=(mode==='ENC'||mode==='DEC');
  const isFile=(mode==='FILE');
  const isB2F =(mode==='B2F');

  el.panelInput.style.display  = (isText||isFile||isB2F)?'block':'none';
  el.panelOutput.style.display = isB2F ? 'none' : 'block';

  el.input.style.display       = (isText||isB2F)?'block':'none';
  el.drop.style.display        = isFile?'block':'none';

  el.textActions.style.display = isText ? 'flex' : 'none';
  el.b2fRows.style.display     = isB2F ? 'flex' : 'none';

  el.qrSend.style.display      = (!isCamMode() && !isB2F) ? 'block' : 'none';
  el.qrRecv.style.display      = isCamMode() ? 'block' : 'none';
  if (isCamMode()) placeCamPanels();

  el.output.placeholder = isFile ? 'ここにBase64が表示されます'
    : (mode==='DEC'||isTextCamMode()) ? 'ここにテキストが表示されます'
    : 'ここに結果が表示されます';

  setDesc(mode);
  drawOverlayGrid();
  autosize(el.input); // 入力の自動リサイズ初期化
}

/* ====== Base64 utils ====== */
function utf8ToB64(str){
  if (window.TextEncoder){
    const bytes = new TextEncoder().encode(str);
    let bin=''; for (const b of bytes) bin+=String.fromCharCode(b);
    return btoa(bin);
  } else { return btoa(unescape(encodeURIComponent(str))); }
}
function normalizeB64(b64){
  let s=(b64||'').trim();
  s=s.replace(/^data:.*;base64,/i,'').replace(/\s+/g,'').replace(/-/g,'+').replace(/_/g,'/');
  s+='='.repeat((4-(s.length%4))%4);
  return s;
}
function b64ToUtf8(b64){
  const clean=normalizeB64(b64);
  if (window.TextDecoder){
    const bin=atob(clean); const bytes=new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
    return new TextDecoder('utf-8').decode(bytes);
  } else { return decodeURIComponent(escape(atob(clean))); }
}

/* ====== Convert / Copy / Paste / Share / Save ====== */
function convert(){
  const s=el.input?.value.trim(); if(!s){ alert('入力が空です'); return; }
  try{ el.output.value = (mode==='ENC') ? utf8ToB64(s) : b64ToUtf8(s); }
  catch(e){ alert('変換に失敗: '+e.message+'\n\n※Base64は改行/URL-safe可、data:ヘッダは自動除去'); }
}
function convertAndQR(){ convert(); if (buildSequence()){ pause(); renderQR(); } }
async function copyOut(){ const s=el.output?.value; if(!s) return; try{ await navigator.clipboard.writeText(s); }catch(_){} }
async function shareOut(){
  const s = el.output?.value.trim();
  if(!s) return;
  if (navigator.share){
    try{ await navigator.share({text:s}); }catch(_){}
  }else{
    try{ await navigator.clipboard.writeText(s); alert('共有に未対応のためコピーしました'); }catch(_){ alert('このブラウザは共有に未対応です'); }
  }
}
async function pasteIn(target){
  try{ const t = await navigator.clipboard.readText(); if(!t) return; target.value = t; autosize(target); }
  catch(_){}
}
function handleFiles(files){
  if(!files||!files.length) return;
  const f=files[0], r=new FileReader();
  r.onload=e=>{ const b64=(String(e.target.result).split(',')[1]||''); el.output.value=b64; };
  r.readAsDataURL(f);
}
function saveFile(){
  const b64=el.input?.value.trim(); if(!b64){ alert('Base64を入力してください'); return;}
  const name=(el.filename?.value.trim()||'download'); const ext=el.filetype?.value||'bin';
  const m = {
    pdf:'application/pdf',
    docx:'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    xlsx:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    pptx:'application/vnd.openxmlformats-officedocument.presentationml.presentation',
    png:'image/png', jpg:'image/jpeg', mp4:'video/mp4',
    exe:'application/vnd.microsoft.portable-executable', bin:'application/octet-stream'
  }[ext] || 'application/octet-stream';
  try{
    const clean=normalizeB64(b64), bin=atob(clean);
    const arr=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
    const blob=new Blob([arr],{type:m}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`${name}.${ext}`; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),1500);
  }catch(e){ alert('保存に失敗: '+e.message); }
}

/* ====== QR sender ====== */
const checksum = str => { let s=0; for(let i=0;i<str.length;i++) s=(s+str.charCodeAt(i))&0xffff; return s; };
const FRAME_RE=/^\[(\d+)\/(\d+)\|(\d+)\]([\s\S]*)$/;

let qrChunks=[], idx=0, playing=false, timer=null, fpsRate=2.0;

function splitFrames(text, maxPayload){
  const total=Math.ceil(text.length/maxPayload)||1, frames=[];
  for(let i=0;i<total;i++){ const p=text.slice(i*maxPayload,(i+1)*maxPayload); frames.push(`[${i+1}/${total}|${checksum(p)}]${p}`); }
  return frames;
}
function splitFramesNoHeader(text,maxPayload){
  const total=Math.ceil(text.length/maxPayload)||1, frames=[];
  for(let i=0;i<total;i++){ frames.push(text.slice(i*maxPayload,(i+1)*maxPayload)); }
  return frames;
}
function buildSequence(){
  const s=el.output?.value.trim(); if(!s){ alert('出力が空です'); return false; }
  if(typeof QRCode==='undefined'){ alert('QRCodeライブラリが読み込まれていません'); return false; }
  const maxPayload=700;
  const withHeader = !(el.noHdr && el.noHdr.checked);
  qrChunks = withHeader ? splitFrames(s,maxPayload) : splitFramesNoHeader(s,maxPayload);
  idx=0; el.scrub.max=Math.max(qrChunks.length-1,0); el.scrub.value=0;
  renderQR(); updateTimeLabels(); updateFrameInd();
  return true;
}
function renderQR(){ el.qrWrap.innerHTML=''; const text=qrChunks[idx]||''; new QRCode(el.qrWrap,{text,width:320,height:320,correctLevel:QRCode.CorrectLevel.M}); }
function updateTimeLabels(){ const total=qrChunks.length; const dur=total/fpsRate; const cur=(idx+1)/fpsRate; el.elapsed.textContent=fmtMMSS(cur); el.duration.textContent=fmtMMSS(dur); }
function updateFrameInd(){ el.frameInd.textContent=`${Math.min(idx+1,qrChunks.length)} / ${qrChunks.length}`; }
function play(){ if(playing||!qrChunks.length) return; playing=true; el.btnPlay.innerHTML='<span class="ms">pause</span>'; tick(); }
function pause(){ playing=false; el.btnPlay.innerHTML='<span class="ms">play_arrow</span>'; if(timer){ clearTimeout(timer); timer=null; } }
function tick(){ if(!playing) return; const interval=Math.max(1,Math.round(1000/fpsRate)); timer=setTimeout(()=>{ if(idx<qrChunks.length-1){ idx++; el.scrub.value=idx; renderQR(); updateTimeLabels(); updateFrameInd(); tick(); } else { pause(); } }, interval); }
function prev(){ if(idx>0){ idx--; el.scrub.value=idx; renderQR(); updateTimeLabels(); updateFrameInd(); } }
function next(){ if(idx<qrChunks.length-1){ idx++; el.scrub.value=idx; renderQR(); updateTimeLabels(); updateFrameInd(); } }
function setFps(val){
  const min=0.5, max=120;
  let v=parseFloat(val); if(isNaN(v)) v=2.0;
  v=Math.min(max, Math.max(min, v));
  fpsRate=v;
  if (el.fps) el.fps.value = String(v);
  if (el.fpsNum) el.fpsNum.value = v.toFixed(1);
  updateTimeLabels();
  if (playing){ pause(); play(); }
}

/* ====== QR receive ====== */
const rx = { total:0, got:new Map() };
const rxTxt = { buffer:'' };
function appendHeaderedAndMaybeComplete(frame){
  const m=FRAME_RE.exec(String(frame).trim()); if(!m) return {matched:false};
  const i=parseInt(m[1],10), total=parseInt(m[2],10), sum=parseInt(m[3],10), payload=m[4];
  if (checksum(payload)!==sum) return {matched:true,ok:false};
  if (!rx.total) rx.total=total; if (rx.total!==total) return {matched:true,ok:false};
  const already = rx.got.has(i) && rx.got.get(i)===payload;
  rx.got.set(i,payload);
  if (el.rxStatus) el.rxStatus.textContent=`${rx.got.size}/${rx.total}`;
  if (already) return {matched:true,ok:true,complete:false};
  if (rx.got.size===rx.total){
    const parts=[]; for(let k=1;k<=rx.total;k++){ const p=rx.got.get(k); if(typeof p!=='string') return {matched:true,ok:false}; parts.push(p); }
    const joined=parts.join(''); rx.total=0; rx.got.clear(); if(el.rxStatus) el.rxStatus.textContent='0/0';
    return {matched:true,ok:true,complete:true,payload:joined};
  }
  return {matched:true,ok:true,complete:false};
}
function ingestFrameToB64(text){
  const r=appendHeaderedAndMaybeComplete(text);
  if(!r.matched){ el.output.value += text; }
  else if(r.complete){ el.output.value = r.payload; }
}
function ingestFrameToText(text){
  const r=appendHeaderedAndMaybeComplete(text);
  if(!r.matched){
    rxTxt.buffer += text;
    try{ el.output.value = b64ToUtf8(rxTxt.buffer); }catch(_){}
  }else if(r.complete){
    try{ el.output.value = b64ToUtf8(r.payload); }catch(_){}
  }
}

/* Camera + overlay */
let camStream=null, rafId=null;
const STABLE_FRAMES = 2;
const DEDUPE_TTL_MS = 8000;
const camD = { curr:'', same:0 };
const slotState = new Map();
const seenHashes = new Map();
function fp32(s){ let h=0x811c9dc5|0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h += (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24); } return h>>>0; }

async function startScan(){
  if(typeof jsQR==='undefined'){ alert('jsQRが読み込まれていません'); return; }
  if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){ alert('このブラウザはカメラ未対応です'); return; }
  try{
    camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}},audio:false});
    el.cam.srcObject = camStream;
    await el.cam.play();
    ensureOverlaySize(); drawOverlayGrid();
    tickCam();
  }catch(e){ alert('カメラ起動に失敗: '+e.message); }
}
function stopScan(){ if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; } if(rafId){ cancelAnimationFrame(rafId); rafId=null; } }
function ensureOverlaySize(){
  const vw=el.cam.videoWidth||1280, vh=el.cam.videoHeight||720;
  const c=el.camOverlay; c.width=vw; c.height=vh;
  c.style.width = el.cam.clientWidth+'px';
  c.style.height= el.cam.clientHeight+'px';
}
function drawOverlayGrid(){
  const ctx=el.camOverlay.getContext('2d');
  ctx.clearRect(0,0,el.camOverlay.width,el.camOverlay.height);
  if (!isMultiMode()) return;
  const rows=Math.max(1,Math.min(6,parseInt(el.rows.value,10)||2));
  const cols=Math.max(1,Math.min(6,parseInt(el.cols.value,10)||2));
  const w=el.camOverlay.width, h=el.camOverlay.height;
  ctx.strokeStyle='rgba(2,132,199,0.9)'; ctx.lineWidth=2;
  for(let r=1;r<rows;r++){ const y=Math.round(h*r/rows)+.5; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
  for(let c=1;c<cols;c++){ const x=Math.round(w*c/cols)+.5; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
}
function drawDetections(dets){
  const ctx = el.camOverlay.getContext('2d');
  drawOverlayGrid();
  for (const d of dets){
    const pts = d.corners;
    ctx.save();
    ctx.lineWidth = 4;
    ctx.strokeStyle = 'rgba(16,185,129,0.95)';
    ctx.shadowColor = 'rgba(0,0,0,0.45)';
    ctx.shadowBlur = 4;
    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    for (let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
    ctx.closePath(); ctx.stroke();
    ctx.restore();
  }
}
function getSlots(){
  const vw=el.cam.videoWidth, vh=el.cam.videoHeight;
  if (!vw||!vh) return [];
  if (!isMultiMode()){
    const m=Math.max(0,parseInt(el.roiMargin.value,10)||0);
    return [{x:m,y:m,w:vw-2*m,h:vh-2*m}];
  }
  const rows=Math.max(1,Math.min(6,parseInt(el.rows.value,10)||2));
  const cols=Math.max(1,Math.min(6,parseInt(el.cols.value,10)||2));
  const m=Math.max(0,parseInt(el.roiMargin.value,10)||0);
  const slots=[]; const cellW=Math.floor(vw/cols), cellH=Math.floor(vh/rows);
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const x=c*cellW + m, y=r*cellH + m;
      const w=(c===cols-1? vw - c*cellW : cellW) - 2*m;
      const h=(r===rows-1? vh - r*cellH : cellH) - 2*m;
      if(w>20 && h>20) slots.push({x,y,w,h});
    }
  }
  return slots;
}
function tickCam(){
  if(!camStream) return;
  const v=el.cam, c=el.camCanvas, ctx=c.getContext('2d');
  const w=v.videoWidth, h=v.videoHeight; if(!w||!h){ rafId=requestAnimationFrame(tickCam); return; }
  c.width=w; c.height=h;

  const slots=getSlots(); if(!slots.length){ rafId=requestAnimationFrame(tickCam); return; }
  const dets=[];
  if (!isMultiMode()){
    ctx.drawImage(v,0,0,w,h);
    const img=ctx.getImageData(0,0,w,h);
    const code=jsQR(img.data,img.width,img.height,{inversionAttempts:'dontInvert'});
    if (code && code.location){
      const L=code.location;
      dets.push({corners:[L.topLeftCorner, L.topRightCorner, L.bottomRightCorner, L.bottomLeftCorner]});
    }
    handleQrResult(code && code.data, null);
  } else {
    for (let i=0;i<slots.length;i++){
      const s=slots[i];
      ctx.drawImage(v, s.x, s.y, s.w, s.h, 0, 0, s.w, s.h);
      const img=ctx.getImageData(0,0,s.w,s.h);
      const code=jsQR(img.data,img.width,img.height,{inversionAttempts:'dontInvert'});
      if (code && code.location){
        const L=code.location, tg=p=>({x:p.x+s.x, y:p.y+s.y});
        dets.push({corners:[tg(L.topLeftCorner), tg(L.topRightCorner), tg(L.bottomRightCorner), tg(L.bottomLeftCorner)]});
      }
      handleQrResult(code && code.data, i);
    }
  }
  drawDetections(dets);
  rafId=requestAnimationFrame(tickCam);
}
function handleQrResult(str, slot){
  if(!str) {
    if (slot!=null){ const st=slotState.get(slot)||{curr:'',same:0}; st.curr=''; st.same=0; slotState.set(slot,st); }
    else { camD.curr=''; camD.same=0; }
    return;
  }
  const m = FRAME_RE.exec(str);
  if (m){
    const i=parseInt(m[1],10), payload=m[4];
    const dup = rx.got.has(i) && rx.got.get(i)===payload;
    if (!dup){ if (isTextCamMode()) ingestFrameToText(str); else ingestFrameToB64(str); }
    if (slot!=null){ const st=slotState.get(slot)||{curr:'',same:0}; st.curr=''; st.same=0; slotState.set(slot,st); }
    else { camD.curr=''; camD.same=0; }
    return;
  }
  // headerless
  const nowProc = (currObj) => {
    if (str===currObj.curr) currObj.same++; else { currObj.curr=str; currObj.same=1; }
    if (currObj.same>=STABLE_FRAMES){
      const h=fp32(str), now=Date.now(), last=seenHashes.get(h)||0;
      if (now-last>DEDUUPE_TTL_MS){} // guard typo prevention (no-op)
      if (now-last>DEDUPE_TTL_MS){
        if (isTextCamMode()){
          ingestFrameToText(str);
          if (el.autoStopHL && el.autoStopHL.checked) stopScan();
        } else ingestFrameToB64(str);
        seenHashes.set(h,now);
        currObj.same=0;
      }
    }
  };
  if (slot!=null){ const st=slotState.get(slot)||{curr:'',same:0}; nowProc(st); slotState.set(slot,st); }
  else nowProc(camD);
}

/* ====== Events ====== */
on(el.mEnc,'click',()=>setMode('ENC'));
on(el.mDec,'click',()=>setMode('DEC'));
on(el.mFile,'click',()=>setMode('FILE'));
on(el.mB2F,'click',()=>setMode('B2F'));
on(el.mCamB64,'click',()=>setMode('CAM_B64'));
on(el.mCamTxt,'click',()=>setMode('CAM_TXT'));
on(el.mCamB64M,'click',()=>setMode('CAM_B64_MULTI'));
on(el.mCamTxtM,'click',()=>setMode('CAM_TXT_MULTI'));

on(el.btnConv,'click',convert);
on(el.btnConvQR,'click',convertAndQR);
on(el.input,'keydown',e=>{
  if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ convert(); }
  if(e.shiftKey && e.key==='Enter'){ e.preventDefault(); convertAndQR(); }
});
on(el.input,'input',()=>autosize(el.input));
on(el.btnClearPlain,'click',()=>{ el.input.value=''; autosize(el.input); el.input.focus(); });
on(el.btnPastePlain,'click',()=> pasteIn(el.input));

on(el.btnCopy,'click',copyOut);
on(el.btnShare,'click',shareOut);
on(el.btnQR,'click',()=>{ if(buildSequence()){ pause(); renderQR(); } });

on(el.fps,'input',()=> setFps(el.fps.value));
on(el.fpsNum,'input',()=> setFps(el.fpsNum.value));
on(el.fpsNum,'change',()=> setFps(el.fpsNum.value));

on(el.btnPrev,'click',prev);
on(el.btnNext,'click',next);
on(el.btnPlay,'click',()=> playing?pause():play());
on(el.scrub,'input',()=>{ idx=parseInt(el.scrub.value||'0',10)||0; renderQR(); updateTimeLabels(); updateFrameInd(); });

on(el.fileBtn,'click',()=>el.fileInput?.click());
on(el.fileInput,'change',()=>handleFiles(el.fileInput?.files));
on(el.drop,'dragover',e=>{ e.preventDefault(); });
on(el.drop,'drop',e=>{ e.preventDefault(); handleFiles(e.dataTransfer?.files); });

on(el.btnSave,'click',saveFile);
on(el.btnClear,'click',()=>{ el.input.value=''; autosize(el.input); el.input.focus(); });
on(el.btnPaste,'click',()=> pasteIn(el.input));

on(el.btnScanStart,'click',startScan);
on(el.btnScanStop,'click',stopScan);

// overlay sizing
el.cam.addEventListener('loadedmetadata', ()=>{ ensureOverlaySize(); drawOverlayGrid(); });
window.addEventListener('resize', ()=>{ ensureOverlaySize(); drawOverlayGrid(); });

// grid setting change
['change','input'].forEach(ev=>{
  on(el.rows,ev,drawOverlayGrid);
  on(el.cols,ev,drawOverlayGrid);
  on(el.roiMargin,ev,drawOverlayGrid);
});

/* ====== Help modal + shortcuts ====== */
const help = el.help;
on(help.btnOpen,'click',()=>{ help.modal.classList.add('show'); help.modal.setAttribute('aria-hidden','false'); });
on(help.btnClose,'click',()=>{ help.modal.classList.remove('show'); help.modal.setAttribute('aria-hidden','true'); });

// キーボードショートカット：? でヘルプ
document.addEventListener('keydown', (e)=>{
  if ((e.shiftKey && e.key === '/') || e.key === '?'){
    help.modal.classList.add('show'); help.modal.setAttribute('aria-hidden','false');
  }
});

/* init */
setMode('ENC');
setFps(el.fps.value);           // 初期FPS=2.0
autosize(el.input);             // 入力テキスト自動リサイズ初期反映
});
</script>
</body>
</html>
